<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××¡ ××§×™×¤×” - ×©×›×™×¨ + ××‘×˜×œ×” + ××™×œ×•××™× + ×¢×¦×××™</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --cyan: #06b6d4;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
        }
        
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            width: 220px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            padding: 20px 0;
            z-index: 100;
            overflow-y: auto;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-size: 1.2rem;
            margin: 0;
            color: var(--primary);
        }
        
        .logo small {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            border-right: 3px solid transparent;
            font-size: 0.9rem;
        }
        
        .nav-item:hover {
            background: rgba(37, 99, 235, 0.1);
        }
        
        .nav-item.active {
            background: rgba(37, 99, 235, 0.2);
            border-right-color: var(--primary);
        }
        
        .main {
            margin-right: 220px;
            padding: 20px 30px;
            min-height: 100vh;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .page-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .stat-card {
            text-align: center;
        }
        
        .stat-card .icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        .stat-card.salary .value { color: var(--cyan); }
        .stat-card.unemployment .value { color: var(--purple); }
        .stat-card.miluim .value { color: var(--success); }
        .stat-card.selfemployed .value { color: var(--warning); }
        .stat-card.total .value { color: var(--primary); }
        .stat-card.tax .value { color: var(--danger); }
        .stat-card.refund .value { color: var(--success); }
        
        .table-container {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .table-header h3 {
            margin: 0;
            font-size: 1rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: rgba(0,0,0,0.2);
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.02);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-icon { padding: 6px 10px; background: transparent; color: var(--text-muted); }
        .btn-icon:hover { color: var(--text); background: rgba(255,255,255,0.1); }
        
        .btn-favorite {
            padding: 8px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .btn-favorite:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .btn-favorite .fav-icon { font-size: 1rem; }
        .btn-favorite .fav-name { max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h3 { margin: 0; }
        
        .modal-body { padding: 20px; }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-start;
            gap: 10px;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .badge-salary { background: rgba(6, 182, 212, 0.2); color: var(--cyan); }
        .badge-unemployment { background: rgba(139, 92, 246, 0.2); color: var(--purple); }
        .badge-miluim { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge-selfemployed { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        
        .summary-box {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.15), rgba(37, 99, 235, 0.05));
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .summary-row.total {
            font-weight: bold;
            font-size: 1.1rem;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid var(--border);
        }
        
        .result-box {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .result-box.refund {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.05));
            border: 2px solid var(--success);
        }
        
        .result-box.owe {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.05));
            border: 2px solid var(--danger);
        }
        
        .result-box .amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .result-box.refund .amount { color: var(--success); }
        .result-box.owe .amount { color: var(--danger); }
        
        .info-box {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .info-box.warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .info-box.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .credit-points-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .credit-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-input);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .credit-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .credit-item input {
            width: 18px;
            height: 18px;
        }
        
        .credit-item label {
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .credit-item .points {
            margin-right: auto;
            color: var(--success);
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            color: var(--primary);
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .breakdown-item .rate {
            color: var(--warning);
            font-size: 0.85rem;
        }
        
        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-input);
            padding: 8px 15px;
            border-radius: 8px;
        }
        
        .year-selector select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            min-width: 80px;
        }
        
        .year-selector select option {
            background: var(--bg-card);
            color: var(--text);
            padding: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        
        .empty-state .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            background: var(--bg-input);
            padding: 5px;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active { background: var(--primary); }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            .sidebar .nav-text, .sidebar .logo small {
                display: none;
            }
            .sidebar .logo h1 {
                font-size: 1rem;
            }
            .main {
                margin-right: 60px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo">
            <h1>ğŸ“Š ××—×©×‘×•×Ÿ ××¡</h1>
            <small>×©×›×™×¨ + ××‘×˜×œ×” + ××™×œ×•××™× + ×¢×¦×××™</small>
        </div>
        <div class="nav-item active" onclick="showPage('dashboard')">
            <span class="icon">ğŸ </span>
            <span class="nav-text">×“×©×‘×•×¨×“</span>
        </div>
        <div class="nav-item" onclick="showPage('salary')">
            <span class="icon">ğŸ’¼</span>
            <span class="nav-text">×”×›× ×¡×” ×›×©×›×™×¨</span>
        </div>
        <div class="nav-item" onclick="showPage('unemployment')">
            <span class="icon">ğŸ“‹</span>
            <span class="nav-text">×“××™ ××‘×˜×œ×”</span>
        </div>
        <div class="nav-item" onclick="showPage('miluim')">
            <span class="icon">ğŸ–ï¸</span>
            <span class="nav-text">××™×œ×•××™×</span>
        </div>
        <div class="nav-item" onclick="showPage('selfemployed')">
            <span class="icon">ğŸ’°</span>
            <span class="nav-text">×¢×¦×××™</span>
        </div>
        <div class="nav-item" onclick="showPage('expenses')">
            <span class="icon">ğŸ§¾</span>
            <span class="nav-text">×”×•×¦××•×ª ××•×›×¨×•×ª</span>
        </div>
        <div class="nav-item" onclick="showPage('vat')" id="navVat" style="display:none;">
            <span class="icon">ğŸ“Š</span>
            <span class="nav-text">××¢"×</span>
        </div>
        <div class="nav-item" onclick="showPage('credits')">
            <span class="icon">â­</span>
            <span class="nav-text">× ×§×•×“×•×ª ×–×™×›×•×™</span>
        </div>
        <div class="nav-item" onclick="showPage('calculation')">
            <span class="icon">ğŸ§®</span>
            <span class="nav-text">×—×™×©×•×‘ ××¤×•×¨×˜</span>
        </div>
        <div class="nav-item" onclick="showPage('settings')">
            <span class="icon">âš™ï¸</span>
            <span class="nav-text">×”×’×“×¨×•×ª</span>
        </div>
    </nav>

    <main class="main">
        <!-- Dashboard -->
        <div id="page-dashboard" class="page active">
            <div class="page-header">
                <h2>ğŸ“Š ×¡×™×›×•× ×©× ×ª×™</h2>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="btn btn-sm" onclick="openModal('dashboardSettingsModal')" title="×”×ª×× ×“×©×‘×•×¨×“">ğŸ¨ ×”×ª×××”</button>
                    <div class="year-selector">
                        <span>ğŸ“…</span>
                        <select id="currentYear" onchange="changeYear()">
                        </select>
                        <button class="btn btn-sm" onclick="openModal('yearModal')" title="× ×”×œ ×©× ×™×">âš™ï¸</button>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <strong>ğŸ’¡ ××™×š ×–×” ×¢×•×‘×“?</strong><br>
                ×”×–×Ÿ ××ª ×›×œ ××§×•×¨×•×ª ×”×”×›× ×¡×” ×©×œ×š (×©×›×™×¨, ××‘×˜×œ×”, ××™×œ×•××™×, ×¢×¦×××™) ×•××ª ×”××¡ ×©×›×‘×¨ × ×•×›×” ×‘××§×•×¨. ×”××¢×¨×›×ª ×ª×—×©×‘ ×× ××’×™×¢ ×œ×š ×”×—×–×¨ ××• ×©××ª×” ×¦×¨×™×š ×œ×©×œ× ×¢×•×“.
            </div>

            <!-- Favorites Bar -->
            <div class="favorites-bar" style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center;">
                <span style="color:var(--text-muted);font-size:0.85rem;">â­ ××•×¢×“×¤×™×:</span>
                <button class="btn btn-favorite" id="fav1" onclick="openFavorite(1)" oncontextmenu="editFavorite(event, 1)">
                    <span class="fav-icon">ğŸ”—</span>
                    <span class="fav-name">××¡ ×”×›× ×¡×”</span>
                </button>
                <button class="btn btn-favorite" id="fav2" onclick="openFavorite(2)" oncontextmenu="editFavorite(event, 2)">
                    <span class="fav-icon">ğŸ”—</span>
                    <span class="fav-name">×‘×™×˜×•×— ×œ××•××™</span>
                </button>
                <button class="btn btn-favorite" id="fav3" onclick="openFavorite(3)" oncontextmenu="editFavorite(event, 3)">
                    <span class="fav-icon">ğŸ”—</span>
                    <span class="fav-name">××¢"×</span>
                </button>
                <button class="btn btn-favorite" id="fav4" onclick="openFavorite(4)" oncontextmenu="editFavorite(event, 4)">
                    <span class="fav-icon">ğŸ“</span>
                    <span class="fav-name">×ª×™×§×™×™×” ××§×•××™×ª</span>
                </button>
                <button class="btn btn-favorite" id="fav5" onclick="openFavorite(5)" oncontextmenu="editFavorite(event, 5)">
                    <span class="fav-icon">âš™ï¸</span>
                    <span class="fav-name">×”×’×“×¨...</span>
                </button>
                <button class="btn btn-icon btn-sm" onclick="openModal('favoritesModal')" title="×¢×¨×•×š ××•×¢×“×¤×™×" style="margin-right:auto;">âœï¸</button>
            </div>

            <div class="cards-grid" id="dashboardCards">
                <div class="card stat-card salary" data-card="salary">
                    <div class="icon">ğŸ’¼</div>
                    <div class="value" id="dashSalary">â‚ª0</div>
                    <div class="label">×”×›× ×¡×” ×›×©×›×™×¨ (×‘×¨×•×˜×•)</div>
                </div>
                <div class="card stat-card unemployment" data-card="unemployment">
                    <div class="icon">ğŸ“‹</div>
                    <div class="value" id="dashUnemployment">â‚ª0</div>
                    <div class="label">×“××™ ××‘×˜×œ×”</div>
                </div>
                <div class="card stat-card miluim" data-card="miluim">
                    <div class="icon">ğŸ–ï¸</div>
                    <div class="value" id="dashMiluim">â‚ª0</div>
                    <div class="label">×“××™ ××™×œ×•××™×</div>
                </div>
                <div class="card stat-card selfemployed" data-card="selfemployed">
                    <div class="icon">ğŸ’°</div>
                    <div class="value" id="dashSelfEmployed">â‚ª0</div>
                    <div class="label">×”×›× ×¡×” ×›×¢×¦×××™</div>
                </div>
            </div>

            <div class="cards-grid" id="dashboardCards2">
                <div class="card stat-card total" data-card="totalIncome">
                    <div class="icon">ğŸ“ˆ</div>
                    <div class="value" id="dashTotalIncome">â‚ª0</div>
                    <div class="label">×¡×”"×› ×”×›× ×¡×” ×—×™×™×‘×ª</div>
                </div>
                <div class="card stat-card" data-card="credits">
                    <div class="icon">â­</div>
                    <div class="value" id="dashCredits">0</div>
                    <div class="label">× ×§×•×“×•×ª ×–×™×›×•×™</div>
                </div>
                <div class="card stat-card tax" data-card="taxDue">
                    <div class="icon">ğŸ›ï¸</div>
                    <div class="value" id="dashTaxDue">â‚ª0</div>
                    <div class="label">××¡ ×”×›× ×¡×” ××—×•×©×‘</div>
                </div>
                <div class="card stat-card" data-card="taxPaid">
                    <div class="icon">âœ…</div>
                    <div class="value" id="dashTaxPaid">â‚ª0</div>
                    <div class="label">××¡ ×”×›× ×¡×” ×©× ×•×›×”/×©×•×œ×</div>
                </div>
                <div class="card stat-card" data-card="blDue" style="border:1px solid var(--warning);">
                    <div class="icon">ğŸ¥</div>
                    <div class="value" id="dashBLDue" style="color:var(--warning)">â‚ª0</div>
                    <div class="label">×‘×™×˜"×œ + ×‘×¨×™××•×ª (×¢×¦×××™)</div>
                </div>
                <div class="card stat-card" data-card="blPaid">
                    <div class="icon">ğŸ’³</div>
                    <div class="value" id="dashBLPaid" style="color:var(--success)">â‚ª0</div>
                    <div class="label">×‘×™×˜"×œ ×©×©×•×œ× (××§×“××•×ª)</div>
                </div>
            </div>

            <div id="dashboardResult">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                    <div class="result-box" id="taxResultBox">
                        <div>ğŸ›ï¸ ××¡ ×”×›× ×¡×”</div>
                        <div class="amount" id="taxResultAmount">â‚ª0</div>
                        <div id="taxResultText">-</div>
                    </div>
                    <div class="result-box" id="blResultBox">
                        <div>ğŸ¥ ×‘×™×˜×•×— ×œ××•××™ + ×‘×¨×™××•×ª</div>
                        <div class="amount" id="blResultAmount">â‚ª0</div>
                        <div id="blResultText">-</div>
                    </div>
                </div>
            </div>

            <div class="summary-box" data-card="paymentsSummary">
                <h3 style="margin:0 0 15px;">ğŸ“‹ ×¤×™×¨×•×˜ ×ª×©×œ×•××™× ×©× ×•×›×•/×©×•×œ××•</h3>
                <div class="summary-row">
                    <span>××¡ ×”×›× ×¡×” ×©× ×•×›×” ××”××©×›×•×¨×ª</span>
                    <span id="dashTaxFromSalary">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>××¡ ×”×›× ×¡×” ×©× ×•×›×” ××“××™ ××‘×˜×œ×”</span>
                    <span id="dashTaxFromUnemployment">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>××¡ ×”×›× ×¡×” ×©× ×•×›×” ××“××™ ××™×œ×•××™×</span>
                    <span id="dashTaxFromMiluim">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>××§×“××•×ª ××¡ ×”×›× ×¡×” (×¢×¦×××™)</span>
                    <span id="dashTaxFromSelf">â‚ª0</span>
                </div>
                <div class="summary-row total">
                    <span>×¡×”"×› ××¡ ×”×›× ×¡×” ×©×©×•×œ×</span>
                    <span id="dashTotalTaxPaid">â‚ª0</span>
                </div>
                <div class="summary-row" style="margin-top:15px;border-top:1px dashed var(--border);padding-top:15px;">
                    <span>××§×“××•×ª ×‘×™×˜"×œ + ×‘×¨×™××•×ª (×¢×¦×××™)</span>
                    <span id="dashTotalBLPaid" style="color:var(--warning)">â‚ª0</span>
                </div>
            </div>
        </div>

        <!-- Salary Page -->
        <div id="page-salary" class="page">
            <div class="page-header">
                <h2>ğŸ’¼ ×”×›× ×¡×” ×›×©×›×™×¨</h2>
                <button class="btn btn-primary" onclick="openModal('salaryModal')">+ ×”×•×¡×£ ×ª×§×•×¤×ª ×¢×‘×•×“×”</button>
            </div>

            <div class="info-box">
                <strong>ğŸ“ ×”×•×¨××•×ª:</strong> ×”×–×Ÿ ××ª ×¤×¨×˜×™ ×”×¢×‘×•×“×” ×›×©×›×™×¨. ××ª ×”× ×ª×•× ×™× ×ª×•×›×œ ×œ××¦×•× ×‘×ª×œ×•×©×™ ×”××©×›×•×¨×ª ××• ×‘×˜×•×¤×¡ 106 ××”××¢×¡×™×§.<br><br>
                <strong>âš ï¸ ×¢×§×¨×•×Ÿ ×”××–×•××Ÿ:</strong> ×‘×™×©×¨××œ ×”××¡ ××—×•×©×‘ ×œ×¤×™ <strong>××•×¢×“ ×§×‘×œ×ª ×”×ª×©×œ×•×</strong>, ×œ× ×œ×¤×™ ×—×•×“×© ×”×¢×‘×•×“×”.<br>
                <small>××©×›×•×¨×ª ×“×¦××‘×¨ 2024 ×©×©×•×œ××” ×‘×™× ×•××¨ 2025 = × ×¡×¤×¨×ª ×œ×©× ×ª 2025 (×ª×•×¤×™×¢ ×‘×˜×•×¤×¡ 106 ×©×œ 2025)</small>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>××¢×¡×™×§</th>
                            <th>×ª×©×œ×•× ×‘×¤×•×¢×œ (×—×•×“×©×™×)</th>
                            <th>×‘×¨×•×˜×•</th>
                            <th>××¡ ×©× ×•×›×”</th>
                            <th>×‘×™×˜"×œ ×©× ×•×›×”</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="salaryTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Unemployment Page -->
        <div id="page-unemployment" class="page">
            <div class="page-header">
                <h2>ğŸ“‹ ×“××™ ××‘×˜×œ×”</h2>
                <button class="btn btn-primary" onclick="openModal('unemploymentModal')">+ ×”×•×¡×£ ×ª×§×•×¤×ª ××‘×˜×œ×”</button>
            </div>

            <div class="info-box">
                <strong>ğŸ“ ×”×•×¨××•×ª:</strong> ×”×–×Ÿ ××ª ×“××™ ×”××‘×˜×œ×” ×©×§×™×‘×œ×ª ××‘×™×˜×•×— ×œ××•××™. ×”××™×“×¢ ××•×¤×™×¢ ×‘××™×©×•×¨ ×”×©× ×ª×™ ××‘×™×˜×•×— ×œ××•××™.<br>
                <strong>âš ï¸ ×¢×§×¨×•×Ÿ ×”××–×•××Ÿ:</strong> ×”×–×Ÿ ×œ×¤×™ ××•×¢×“ ×§×‘×œ×ª ×”×ª×©×œ×•× ×‘×¤×•×¢×œ (××ª×™ × ×›× ×¡ ×œ×‘× ×§).
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>×ª×©×œ×•× ×‘×¤×•×¢×œ (×—×•×“×©×™×)</th>
                            <th>×¡×›×•× ×‘×¨×•×˜×•</th>
                            <th>××¡ ×©× ×•×›×”</th>
                            <th>×‘×™×˜"×œ ×©× ×•×›×”</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="unemploymentTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Miluim Page -->
        <div id="page-miluim" class="page">
            <div class="page-header">
                <h2>ğŸ–ï¸ ×©×™×¨×•×ª ××™×œ×•××™×</h2>
                <button class="btn btn-primary" onclick="openModal('miluimModal')">+ ×”×•×¡×£ ×ª×§×•×¤×ª ××™×œ×•××™×</button>
            </div>

            <div class="info-box">
                <strong>ğŸ’¡ ×“××™ ××™×œ×•××™× = ×”×›× ×¡×” ×¨×’×™×œ×” ×—×™×™×‘×ª ×‘××¡</strong><br>
                â€¢ ××”×ª×’××•×œ ×× ×•×›×™×: ××¡ ×”×›× ×¡×”, ×‘×™×˜×•×— ×œ××•××™ ×•××¡ ×‘×¨×™××•×ª<br>
                â€¢ <strong>×¢×¦×××™×</strong> ××§×‘×œ×™× ×ª×•×¡×¤×ª ×¤×™×¦×•×™ ×©×œ 25% ×¢×œ ×”×ª×’××•×œ
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>×ª×§×•×¤×”</th>
                            <th>××¡×¤×¨ ×™××™×</th>
                            <th>×¡×›×•× ×‘×¨×•×˜×•</th>
                            <th>××¡ ×©× ×•×›×”</th>
                            <th>×‘×™×˜"×œ ×©× ×•×›×”</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="miluimTable"></tbody>
                </table>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin:0 0 15px;">ğŸ“Š ×¡×™×›×•× ××™×œ×•××™×</h3>
                <div class="summary-row">
                    <span>×¡×”"×› ×™××™ ××™×œ×•××™×</span>
                    <span id="totalMiluimDays">0</span>
                </div>
                <div class="summary-row">
                    <span>×¡×”"×› ×ª×’××•×œ ×‘×¨×•×˜×•</span>
                    <span id="totalMiluimAmount">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>×¡×”"×› ××¡ ×©× ×•×›×”</span>
                    <span id="totalMiluimTax" style="color:var(--danger)">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>×¡×”"×› ×‘×™×˜"×œ ×©× ×•×›×”</span>
                    <span id="totalMiluimBL" style="color:var(--warning)">â‚ª0</span>
                </div>
            </div>
        </div>

        <!-- Self Employed Page -->
        <div id="page-selfemployed" class="page">
            <div class="page-header">
                <h2>ğŸ’° ×”×›× ×¡×” ×›×¢×¦×××™</h2>
                <button class="btn btn-primary" onclick="openModal('selfEmployedModal')">+ ×”×•×¡×£ ×”×›× ×¡×”</button>
            </div>

            <div class="info-box warning" id="selfEmployedWarning" style="display:none;">
                <strong>âš ï¸ ×©×™× ×œ×‘:</strong> ×× ×¤×ª×—×ª ×¢×•×¡×§ ×‘×××¦×¢ ×”×©× ×”, ×”×”×›× ×¡×•×ª ××”×¢×¡×§ ××¦×˜×¨×¤×•×ª ×œ×©××¨ ×”×”×›× ×¡×•×ª ×©×œ×š ×œ×¦×•×¨×š ×—×™×©×•×‘ ××“×¨×’×•×ª ×”××¡.
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>×—×•×“×©</th>
                            <th>×ª×™××•×¨</th>
                            <th>×¡×›×•×</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="selfEmployedTable"></tbody>
                </table>
            </div>

            <div class="card" style="margin-top:20px;">
                <div class="table-header" style="padding:15px 0;">
                    <h3 style="margin:0;">ğŸ›ï¸ ××§×“××•×ª ××¡ ×”×›× ×¡×”</h3>
                    <button class="btn btn-primary btn-sm" onclick="openModal('taxAdvanceModal')">+ ×”×•×¡×£ ×ª×©×œ×•×</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>×—×•×“×©</th>
                            <th>×¡×›×•×</th>
                            <th>××¦×˜×‘×¨</th>
                            <th>××¡××š</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="taxAdvanceTable"></tbody>
                    <tfoot id="taxAdvanceTotals"></tfoot>
                </table>
            </div>

            <div class="card" style="margin-top:20px;">
                <div class="table-header" style="padding:15px 0;">
                    <h3 style="margin:0;">ğŸ¥ ×‘×™×˜×•×— ×œ××•××™ + ××¡ ×‘×¨×™××•×ª</h3>
                    <button class="btn btn-primary btn-sm" onclick="openModal('blAdvanceModal')">+ ×”×•×¡×£ ×ª×©×œ×•×</button>
                </div>
                <div class="info-box" style="margin:10px 0;">
                    ğŸ’¡ ×‘×™×˜×•×— ×œ××•××™ ×•××¡ ×‘×¨×™××•×ª ××©×•×œ××™× ×‘×™×—×“ ×œ×‘×™×˜×•×— ×œ××•××™
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>×—×•×“×©</th>
                            <th>×¡×›×•×</th>
                            <th>××¦×˜×‘×¨</th>
                            <th>××¡××š</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="blAdvanceTable"></tbody>
                    <tfoot id="blAdvanceTotals"></tfoot>
                </table>
            </div>
        </div>

        <!-- Expenses Page -->
        <div id="page-expenses" class="page">
            <div class="page-header">
                <h2>ğŸ§¾ ×”×•×¦××•×ª ××•×›×¨×•×ª (×¢×¦×××™)</h2>
                <button class="btn btn-primary" onclick="openModal('expenseModal')">+ ×”×•×¡×£ ×”×•×¦××”</button>
            </div>

            <div class="info-box">
                <strong>ğŸ’¡ ××” ×–×” ×”×•×¦××•×ª ××•×›×¨×•×ª?</strong><br>
                ×”×•×¦××•×ª ×©×”×•×¦××ª ×œ×¦×•×¨×š ×”×¤×§×ª ×”×”×›× ×¡×” ×›×¢×¦×××™. ×”×Ÿ ××§×˜×™× ×•×ª ××ª ×”×”×›× ×¡×” ×”×—×™×™×‘×ª ×‘××¡.
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>×ª××¨×™×š</th>
                            <th>×ª×™××•×¨</th>
                            <th>×§×˜×’×•×¨×™×”</th>
                            <th>×¡×›×•×</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="expenseTable"></tbody>
                </table>
            </div>

            <div class="summary-box">
                <div class="summary-row total">
                    <span>×¡×”"×› ×”×•×¦××•×ª ××•×›×¨×•×ª</span>
                    <span id="totalExpenses">â‚ª0</span>
                </div>
            </div>
        </div>

        <!-- VAT Page (for ×¢×•×¡×§ ××•×¨×©×”) -->
        <div id="page-vat" class="page">
            <div class="page-header">
                <h2>ğŸ“Š ××¢"×</h2>
                <button class="btn btn-primary" onclick="openModal('vatModal')">+ ×”×•×¡×£ ×“×™×•×•×—</button>
            </div>

            <div class="info-box">
                <strong>ğŸ’¡ ××¢"× ×œ×¢×•×¡×§ ××•×¨×©×”:</strong><br>
                â€¢ ×™×¦×•× ×œ×—×•"×œ (×©×™×¨×•×ª×™× ×œ×—×•"×œ) = <strong>0% ××¢"×</strong> ×¢×œ ×”×›× ×¡×•×ª<br>
                â€¢ ××¢"× ×¢×œ ×”×•×¦××•×ª (17%) = <strong>××’×™×¢ ×œ×š ×”×—×–×¨!</strong><br>
                â€¢ ×™×© ×œ×”×’×™×© ×“×•"×— ×—×•×“×©×™/×“×•-×—×•×“×©×™ ×œ×¨×©×•×ª ×”××¡×™×
            </div>

            <div class="cards-grid" style="margin-bottom:20px;">
                <div class="card stat-card">
                    <div class="icon">ğŸ“ˆ</div>
                    <div class="value" id="vatIncome">â‚ª0</div>
                    <div class="label">×”×›× ×¡×•×ª (×œ×¤× ×™ ××¢"×)</div>
                </div>
                <div class="card stat-card">
                    <div class="icon">ğŸ“‰</div>
                    <div class="value" id="vatExpenses">â‚ª0</div>
                    <div class="label">×”×•×¦××•×ª (×œ×¤× ×™ ××¢"×)</div>
                </div>
                <div class="card stat-card">
                    <div class="icon">ğŸ’°</div>
                    <div class="value" id="vatOnExpenses" style="color:var(--success)">â‚ª0</div>
                    <div class="label">××¢"× ×¢×œ ×”×•×¦××•×ª (×œ×§×™×–×•×–)</div>
                </div>
            </div>

            <div class="card">
                <div class="table-header">
                    <h3>×“×™×•×•×—×™ ××¢"×</h3>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>×ª×§×•×¤×”</th>
                            <th>×”×›× ×¡×•×ª</th>
                            <th>××¢"× ×¢×¡×§××•×ª</th>
                            <th>××¢"× ×ª×©×•××•×ª</th>
                            <th>×œ×ª×©×œ×•×/×”×—×–×¨</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="vatTable"></tbody>
                </table>
            </div>

            <div class="result-box refund" style="margin-top:20px;" id="vatResultBox">
                <div>ğŸ’° ×¡×”"×› ××¢"× ×œ×§×™×–×•×– (×”×—×–×¨ ×¦×¤×•×™)</div>
                <div class="amount" id="vatTotalRefund">â‚ª0</div>
                <div>×‘×ª× ××™ ×©×”×”×›× ×¡×•×ª ××™×¦×•× ×œ×—×•"×œ (0% ××¢"×)</div>
            </div>
        </div>

        <!-- Credits Page -->
        <div id="page-credits" class="page">
            <div class="page-header">
                <h2>â­ × ×§×•×“×•×ª ×–×™×›×•×™</h2>
            </div>

            <div class="info-box">
                <strong>ğŸ’¡ ××” ×–×” × ×§×•×“×•×ª ×–×™×›×•×™?</strong><br>
                × ×§×•×“×•×ª ×–×™×›×•×™ ××¤×—×™×ª×•×ª ××ª ×”××¡ ×©×¢×œ×™×š ×œ×©×œ×. ×›×œ × ×§×•×“×” ×©×•×•×” <strong>â‚ª242 ×‘×—×•×“×©</strong> (â‚ª2,904 ×‘×©× ×”).
            </div>

            <div class="card">
                <h3 style="margin:0 0 20px;">×‘×—×¨ ××ª × ×§×•×“×•×ª ×”×–×™×›×•×™ ×©××’×™×¢×•×ª ×œ×š:</h3>
                
                <div class="section-title">ğŸ  ×‘×¡×™×¡</div>
                <div class="credit-points-grid">
                    <div class="credit-item">
                        <input type="checkbox" id="credit_resident" checked disabled>
                        <label for="credit_resident">×ª×•×©×‘ ×™×©×¨××œ</label>
                        <span class="points">2.25</span>
                    </div>
                    <div class="credit-item">
                        <input type="checkbox" id="credit_woman" onchange="updateCredits()">
                        <label for="credit_woman">××™×©×”</label>
                        <span class="points">0.5</span>
                    </div>
                </div>

                <div class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ××©×¤×—×”</div>
                <div class="credit-points-grid">
                    <div class="credit-item" style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);">
                        <input type="checkbox" id="credit_divorced_alimony" onchange="updateCredits()">
                        <label for="credit_divorced_alimony">×’×¨×•×©/×” ××©×œ×/×ª ××–×•× ×•×ª</label>
                        <span class="points">1</span>
                    </div>
                    <div class="credit-item">
                        <input type="checkbox" id="credit_single_parent" onchange="updateCredits()">
                        <label for="credit_single_parent">×”×•×¨×” ×™×—×™×“ (×™×œ×“×™× ×‘×—×–×§×ª×š)</label>
                        <span class="points">1</span>
                    </div>
                </div>
                <div class="form-row" style="margin-top:15px;">
                    <div class="form-group">
                        <label>×™×œ×“×™× ×¢×“ ×’×™×œ 5 (×‘×—×–×§×ª×š)</label>
                        <input type="number" class="form-control" id="children_young" value="0" min="0" onchange="updateCredits()">
                        <small style="color:var(--text-muted)">2.5 × ×§' ×œ×™×œ×“</small>
                    </div>
                    <div class="form-group">
                        <label>×™×œ×“×™× ×’×™×œ 6-17 (×‘×—×–×§×ª×š)</label>
                        <input type="number" class="form-control" id="children_old" value="0" min="0" onchange="updateCredits()">
                        <small style="color:var(--text-muted)">1 × ×§' ×œ×™×œ×“</small>
                    </div>
                </div>

                <div class="section-title">ğŸ–ï¸ ×©×™×¨×•×ª</div>
                <div class="credit-points-grid">
                    <div class="credit-item">
                        <input type="checkbox" id="credit_army" onchange="updateCredits()">
                        <label for="credit_army">×©×™×¨×•×ª ×¦×‘××™/×œ××•××™ (2 ×©× ×™× ××”×©×—×¨×•×¨)</label>
                        <span class="points">2</span>
                    </div>
                </div>

                <div class="section-title">ğŸ“ ×”×©×›×œ×”</div>
                <div class="credit-points-grid">
                    <div class="credit-item">
                        <input type="checkbox" id="credit_degree" onchange="updateCredits()">
                        <label for="credit_degree">×ª×•××¨ ××§×“××™</label>
                        <span class="points">1</span>
                    </div>
                    <div class="credit-item">
                        <input type="checkbox" id="credit_degree2" onchange="updateCredits()">
                        <label for="credit_degree2">×ª×•××¨ ×©× ×™</label>
                        <span class="points">0.5</span>
                    </div>
                </div>

                <div class="section-title">ğŸŒ ××—×¨</div>
                <div class="credit-points-grid">
                    <div class="credit-item">
                        <input type="checkbox" id="credit_oleh" onchange="updateCredits()">
                        <label for="credit_oleh">×¢×•×œ×” ×—×“×© (3.5 ×©× ×™× ×¨××©×•× ×•×ª)</label>
                        <span class="points">2.25</span>
                    </div>
                </div>
            </div>

            <div class="summary-box" style="margin-top:20px;">
                <div class="summary-row total">
                    <span>×¡×”"×› × ×§×•×“×•×ª ×–×™×›×•×™</span>
                    <span id="totalCredits" style="color:var(--warning);font-size:1.5rem;">2.25</span>
                </div>
                <div class="summary-row">
                    <span>×©×•×•×™ ×”×–×™×›×•×™ ×”×©× ×ª×™</span>
                    <span id="creditValue" style="color:var(--success);">â‚ª6,534</span>
                </div>
            </div>
        </div>

        <!-- Calculation Page -->
        <div id="page-calculation" class="page">
            <div class="page-header">
                <h2>ğŸ§® ×—×™×©×•×‘ ××¡ ××¤×•×¨×˜</h2>
            </div>

            <div class="card">
                <h3 style="margin:0 0 20px;">ğŸ“Š ×¡×™×›×•× ×”×›× ×¡×•×ª</h3>
                <div class="summary-row">
                    <span>×”×›× ×¡×” ×›×©×›×™×¨ (×‘×¨×•×˜×•)</span>
                    <span id="calcSalary">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>×“××™ ××‘×˜×œ×”</span>
                    <span id="calcUnemployment">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>×”×›× ×¡×” ×›×¢×¦×××™</span>
                    <span id="calcSelfEmployed">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span style="color:var(--danger)">(-) ×”×•×¦××•×ª ××•×›×¨×•×ª</span>
                    <span id="calcExpenses" style="color:var(--danger)">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>×“××™ ××™×œ×•××™×</span>
                    <span id="calcMiluim">â‚ª0</span>
                </div>
                <div class="summary-row total">
                    <span>×¡×”"×› ×”×›× ×¡×” ×—×™×™×‘×ª ×‘××¡</span>
                    <span id="calcTaxableIncome">â‚ª0</span>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin:0 0 20px;">ğŸ“ˆ ×—×™×©×•×‘ ××¡ ×”×›× ×¡×” ×œ×¤×™ ××“×¨×’×•×ª</h3>
                <div id="taxBracketsBreakdown"></div>
                <div class="summary-row" style="margin-top:15px;">
                    <span>××¡ ×‘×¨×•×˜×• (×œ×¤× ×™ ×–×™×›×•×™×™×)</span>
                    <span id="calcGrossTax">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span style="color:var(--success)">(-) ×–×™×›×•×™ × ×§×•×“×•×ª (<span id="calcCreditPoints">0</span> Ã— â‚ª2,904)</span>
                    <span id="calcCreditValue" style="color:var(--success)">â‚ª0</span>
                </div>
                <div class="summary-row total">
                    <span>××¡ ×”×›× ×¡×” ×œ×ª×©×œ×•×</span>
                    <span id="calcNetTax" style="color:var(--danger)">â‚ª0</span>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin:0 0 20px;">ğŸ›ï¸ ×‘×™×˜×•×— ×œ××•××™ + ××¡ ×‘×¨×™××•×ª (×¢×œ ×”×›× ×¡×” ×›×¢×¦×××™)</h3>
                <div class="info-box" style="margin-bottom:15px;font-size:0.85rem;">
                    ğŸ’¡ ×”×¡×›×•××™× ×›×•×œ×œ×™× ×’× ×‘×™×˜×•×— ×œ××•××™ ×•×’× ××¡ ×‘×¨×™××•×ª - ××©×•×œ××™× ×‘×™×—×“ ×œ×‘×™×˜×•×— ×œ××•××™
                </div>
                <div class="summary-row">
                    <span>×”×›× ×¡×” ×›×¢×¦×××™ (× ×˜×• ××”×•×¦××•×ª)</span>
                    <span id="calcBLIncome">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>×©×™×¢×•×¨ ××•×¤×—×ª (7.70% ×¢×“ â‚ª90,264)</span>
                    <span id="calcBLReduced">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>×©×™×¢×•×¨ ××œ× (18% ××¢×œ â‚ª90,264)</span>
                    <span id="calcBLFull">â‚ª0</span>
                </div>
                <div class="summary-row total">
                    <span>×¡×”"×› ×‘×™×˜×•×— ×œ××•××™ + ×‘×¨×™××•×ª (××—×•×©×‘)</span>
                    <span id="calcTotalBL" style="color:var(--warning)">â‚ª0</span>
                </div>
                <div class="summary-row" style="background:rgba(16,185,129,0.1);margin:10px -20px;padding:10px 20px;">
                    <span>âœ… ×‘×™×˜×•×— ×œ××•××™ ×©×©×•×œ× (××›×œ ×”××§×•×¨×•×ª)</span>
                    <span id="calcBLPaid" style="color:var(--success)">â‚ª0</span>
                </div>
                <div class="summary-row" id="blDiffRow">
                    <span id="blDiffLabel">×”×¤×¨×©</span>
                    <span id="blDiff">â‚ª0</span>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin:0 0 20px;">âœ… ××¡ ×”×›× ×¡×” ×©× ×•×›×”/×©×•×œ×</h3>
                <div class="summary-row">
                    <span>××¡ ×©× ×•×›×” ××”××©×›×•×¨×ª</span>
                    <span id="calcPaidSalary">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>××¡ ×©× ×•×›×” ××“××™ ××‘×˜×œ×”</span>
                    <span id="calcPaidUnemployment">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>××¡ ×©× ×•×›×” ××“××™ ××™×œ×•××™×</span>
                    <span id="calcPaidMiluim">â‚ª0</span>
                </div>
                <div class="summary-row">
                    <span>××§×“××•×ª ××¡ ×”×›× ×¡×” (×¢×¦×××™)</span>
                    <span id="calcPaidSelf">â‚ª0</span>
                </div>
                <div class="summary-row total">
                    <span>×¡×”"×› ××¡ ×”×›× ×¡×” ×©×©×•×œ×</span>
                    <span id="calcTotalPaid" style="color:var(--success)">â‚ª0</span>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;">
                <div class="card">
                    <h3 style="margin:0 0 15px;">ğŸ›ï¸ ×¡×™×›×•× ××¡ ×”×›× ×¡×”</h3>
                    <div class="summary-row">
                        <span>××¡ ××—×•×©×‘</span>
                        <span id="calcSummaryTaxDue">â‚ª0</span>
                    </div>
                    <div class="summary-row">
                        <span>××¡ ×©×©×•×œ×</span>
                        <span id="calcSummaryTaxPaid">â‚ª0</span>
                    </div>
                    <div class="summary-row total" id="calcTaxResultRow">
                        <span id="calcTaxResultLabel">×”×¤×¨×©</span>
                        <span id="calcTaxResult">â‚ª0</span>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin:0 0 15px;">ğŸ¥ ×¡×™×›×•× ×‘×™×˜×•×— ×œ××•××™</h3>
                    <div class="summary-row">
                        <span>×‘×™×˜"×œ ××—×•×©×‘</span>
                        <span id="calcSummaryBLDue">â‚ª0</span>
                    </div>
                    <div class="summary-row">
                        <span>×‘×™×˜"×œ ×©×©×•×œ×</span>
                        <span id="calcSummaryBLPaid">â‚ª0</span>
                    </div>
                    <div class="summary-row total" id="calcBLResultRow">
                        <span id="calcBLResultLabel">×”×¤×¨×©</span>
                        <span id="calcBLResult">â‚ª0</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Settings Page -->
        <div id="page-settings" class="page">
            <div class="page-header">
                <h2>âš™ï¸ ×”×’×“×¨×•×ª ××¢×¨×›×ª</h2>
            </div>

            <div class="info-box" style="margin-bottom:20px;background:rgba(59,130,246,0.1);border-color:var(--primary);">
                <strong>ğŸ“… ×”×’×“×¨×•×ª ×œ×©× ×ª <span id="settingsYearDisplay">2025</span></strong><br>
                ×›×œ ×”×”×’×“×¨×•×ª ×‘×¢××•×“ ×–×” (××“×¨×’×•×ª ××¡, ××¢××“ ×¢×•×¡×§, ×©×™×¢×•×¨×™ ×‘×™×˜"×œ) × ×©××¨×•×ª ×‘× ×¤×¨×“ ×œ×›×œ ×©× ×”
            </div>

            <div class="card" style="margin-bottom:20px;">
                <h3 style="margin:0 0 15px;">ğŸ¢ ××¢××“ ×¢×¡×§×™</h3>
                <div class="form-group">
                    <label>×¡×•×’ ×¢×•×¡×§</label>
                    <select class="form-control" id="businessStatus" onchange="updateBusinessStatus()">
                        <option value="zair">×¢×•×¡×§ ×–×¢×™×¨ (×¢×“ 120,000â‚ª ×‘×©× ×”)</option>
                        <option value="patur">×¢×•×¡×§ ×¤×˜×•×¨ (×¢×“ 107,692â‚ª ×‘×©× ×”)</option>
                        <option value="murshe">×¢×•×¡×§ ××•×¨×©×” (×¢× ××¢"×)</option>
                    </select>
                </div>
                <div id="vatInfo" style="display:none;">
                    <div class="info-box">
                        <strong>ğŸ’¡ ××¢"× ×œ×¢×•×¡×§ ××•×¨×©×”:</strong><br>
                        â€¢ ×™×¦×•× ×œ×—×•"×œ = 0% ××¢"× ×¢×œ ×”×›× ×¡×•×ª<br>
                        â€¢ ××§×–×– ××¢"× ×¢×œ ×”×•×¦××•×ª = ××’×™×¢ ×”×—×–×¨!<br>
                        â€¢ ×—×•×‘×” ×œ×”×’×™×© ×“×•"×— ××¢"× ×—×•×“×©×™/×“×•-×—×•×“×©×™
                    </div>
                    <div class="form-group">
                        <label>×©×™×¢×•×¨ ××¢"× (%)</label>
                        <input type="number" class="form-control" id="vatRate" value="17" step="0.1">
                    </div>
                </div>
            </div>

            <div class="cards-grid">
                <div class="card">
                    <h3 style="margin:0 0 15px;">ğŸ“Š ××“×¨×’×•×ª ××¡ <span id="taxBracketsYear">2025</span></h3>
                    <div id="settingsBrackets"></div>
                </div>

                <div class="card">
                    <h3 style="margin:0 0 15px;">ğŸ›ï¸ ×‘×™×˜×•×— ×œ××•××™ + ×‘×¨×™××•×ª ×œ×¢×¦×××™× <span id="blBracketsYear">2025</span></h3>
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:10px;">ğŸ’¡ ×”×¡×›×•××™× ×©× ×ª×™×™× (×—×•×“×©×™ Ã— 12) ×œ×”×ª×—×©×‘× ×•×ª ×¡×•×£ ×©× ×”</div>
                    <div id="settingsBLBrackets"></div>
                    <div class="info-box" style="margin-top:15px;font-size:0.85rem;">
                        <strong>ğŸ“Š ××§×•×¨:</strong> <a href="https://www.btl.gov.il/Insurance/National%20Insurance/type_list/Self_Employed/Pages/rates.aspx" target="_blank" style="color:var(--primary);">××ª×¨ ×‘×™×˜×•×— ×œ××•××™</a><br>
                        <span style="color:var(--text-muted);">×—×•×“×©×™: â‚ª7,522 / â‚ª50,695 â†’ ×©× ×ª×™: â‚ª90,264 / â‚ª608,340</span>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin:0 0 15px;">â­ × ×§×•×“×•×ª ×–×™×›×•×™</h3>
                    <div class="form-group">
                        <label>×¢×¨×š × ×§×•×“×” (×—×•×“×©×™)</label>
                        <input type="number" class="form-control" id="setCreditValue" value="242" onchange="updateCreditValue()">
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin:0 0 15px;">â˜ï¸ ×¡× ×›×¨×•×Ÿ Google Drive</h3>
                <div class="info-box">
                    <strong>ğŸ’¡ ××™×š ×–×” ×¢×•×‘×“?</strong><br>
                    â€¢ ×”× ×ª×•× ×™× × ×©××¨×™× ××§×•××™×ª ×‘×“×¤×“×¤×Ÿ<br>
                    â€¢ ×œ×—×¥ "×’×™×‘×•×™ ×œ-Drive" ×›×“×™ ×œ×©××•×¨ ×¢×•×ª×§ ×‘×¢× ×Ÿ<br>
                    â€¢ ×œ×—×¥ "×©×—×–×•×¨ ×-Drive" ×›×“×™ ×œ×˜×¢×•×Ÿ ××”×¢× ×Ÿ<br>
                    â€¢ ×›×š ×ª×•×›×œ ×œ×’×©×ª ××›×œ ××—×©×‘!
                </div>
                <div id="driveStatus" style="padding:10px;background:var(--bg-input);border-radius:8px;margin-bottom:15px;">
                    <span id="driveStatusText">×œ× ××—×•×‘×¨ ×œ-Google Drive</span>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="initGoogleDrive()">ğŸ”— ×”×ª×—×‘×¨ ×œ-Google</button>
                    <button class="btn btn-success" onclick="backupToDrive()" id="btnBackup" disabled>ğŸ“¤ ×’×™×‘×•×™ ×œ-Drive</button>
                    <button class="btn btn-primary" onclick="restoreFromDrive()" id="btnRestore" disabled>ğŸ“¥ ×©×—×–×•×¨ ×-Drive</button>
                </div>
                <div id="lastSyncTime" style="margin-top:10px;color:var(--text-muted);font-size:0.85rem;"></div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin:0 0 15px;">ğŸ“ ×ª×™×§×™×™×ª ××¡××›×™× ××§×•××™×ª</h3>
                <div class="info-box">
                    <strong>ğŸ’¡ ×œ××” ×¦×¨×™×š?</strong><br>
                    â€¢ ×’×™×©×” ××”×™×¨×” ×œ××¡××›×™× ××”××—×©×‘<br>
                    â€¢ ×§×œ ×œ×¦×¨×£ ×œ××™×™×œ<br>
                    â€¢ ×’×™×‘×•×™ ××§×•××™ ×‘× ×•×¡×£ ×œ×¢× ×Ÿ
                </div>
                <div id="localFolderStatus" style="padding:15px;background:var(--bg-input);border-radius:8px;margin:15px 0;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span id="localFolderIcon" style="font-size:1.5rem;">ğŸ“</span>
                        <div>
                            <div id="localFolderPath" style="font-weight:bold;">×œ× × ×‘×—×¨×” ×ª×™×§×™×™×”</div>
                            <div id="localFolderHint" style="font-size:0.85rem;color:var(--text-muted);">×‘×—×¨ ×ª×™×§×™×™×” ×œ×©××™×¨×ª ×”××¡××›×™×</div>
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="selectLocalFolder()">ğŸ“‚ ×‘×—×¨ ×ª×™×§×™×™×”</button>
                    <button class="btn btn-success" onclick="createLocalFolderStructure()" id="btnCreateLocalFolders" disabled>ğŸ“ ×¦×•×¨ ××‘× ×” ×ª×™×§×™×•×ª</button>
                    <button class="btn" onclick="openLocalFolder()" id="btnOpenLocalFolder" disabled>ğŸ“‹ ×”×¢×ª×§ × ×ª×™×‘</button>
                    <button class="btn btn-primary" onclick="restoreFromLocalFolder()" id="btnRestoreLocal" disabled>ğŸ“¥ ×©×—×–×¨ ××ª×™×§×™×™×”</button>
                </div>
                <div id="localFolderBrowserWarning" style="display:none;margin-top:10px;padding:10px;background:rgba(245,158,11,0.1);border-radius:8px;color:var(--warning);">
                    âš ï¸ ×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×’×™×©×” ×œ×ª×™×§×™×•×ª. ×”×©×ª××© ×‘-Chrome ××• Edge.
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin:0 0 15px;">ğŸ“„ ××‘× ×” ×ª×™×§×™×•×ª</h3>
                <div class="info-box">
                    <code style="background:var(--bg-input);padding:10px;display:block;margin-top:10px;border-radius:5px;direction:ltr;text-align:left;">
ğŸ“ john-finance/<br>
â”œâ”€â”€ ğŸ“ 2025/<br>
â”‚   â”œâ”€â”€ ğŸ“ ×©×›×™×¨/<br>
â”‚   â”œâ”€â”€ ğŸ“ ××§×“××•×ª-××¡/<br>
â”‚   â”œâ”€â”€ ğŸ“ ×‘×™×˜×•×—-×œ××•××™/<br>
â”‚   â”œâ”€â”€ ğŸ“ ×—×©×‘×•× ×™×•×ª-×¢×¦×××™/<br>
â”‚   â”œâ”€â”€ ğŸ“ ×”×•×¦××•×ª-××•×›×¨×•×ª/<br>
â”‚   â”œâ”€â”€ ğŸ“ ××™×œ×•××™×/<br>
â”‚   â””â”€â”€ ğŸ“ ××‘×˜×œ×”/<br>
â”œâ”€â”€ ğŸ“ 2024/<br>
â”‚   â””â”€â”€ ...<br>
â””â”€â”€ ğŸ“„ data.json
                    </code>
                </div>
                <button class="btn btn-primary" onclick="createFolderStructure()" id="btnCreateDriveFolders" disabled>ğŸ“ ×¦×•×¨ ××‘× ×” ×ª×™×§×™×•×ª ×‘-Drive</button>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin:0 0 15px;">ğŸ’¾ ×’×™×‘×•×™ ×•×©×—×–×•×¨ ××§×•××™</h3>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="exportData()">ğŸ“¥ ×™×™×¦× × ×ª×•× ×™×</button>
                    <button class="btn btn-success" onclick="document.getElementById('importFile').click()">ğŸ“¤ ×™×™×‘× × ×ª×•× ×™×</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                    <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ × ×§×” ×”×›×œ</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div class="modal-overlay" id="salaryModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ’¼ ×”×•×¡×£ ×ª×§×•×¤×ª ×¢×‘×•×“×” ×›×©×›×™×¨</h3>
                <button class="btn-icon" onclick="closeModal('salaryModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="info-box warning" style="margin-bottom:15px;">
                    <strong>âš ï¸ ×—×©×•×‘ - ×¢×§×¨×•×Ÿ ×”××–×•××Ÿ:</strong><br>
                    ×™×© ×œ×”×–×™×Ÿ ×œ×¤×™ <strong>××•×¢×“ ×”×ª×©×œ×•× ×‘×¤×•×¢×œ</strong>, ×œ× ×œ×¤×™ ×”×—×•×“×© ×©×¢×‘×•×¨×• ×¢×‘×“×ª.<br>
                    <small>×œ×“×•×’××”: ××©×›×•×¨×ª ×“×¦××‘×¨ 2024 ×©×©×•×œ××” ×‘×™× ×•××¨ 2025 â†’ × ×¡×¤×¨×ª ×œ-2025</small>
                </div>
                <div class="form-group">
                    <label>×©× ×”××¢×¡×™×§</label>
                    <input type="text" class="form-control" id="salaryEmployer">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>×ª×©×œ×•× ××—×•×“×© (××ª×™ × ×›× ×¡ ×œ×‘× ×§)</label>
                        <select class="form-control" id="salaryFromMonth">
                            <option value="1">×™× ×•××¨</option>
                            <option value="2">×¤×‘×¨×•××¨</option>
                            <option value="3">××¨×¥</option>
                            <option value="4">××¤×¨×™×œ</option>
                            <option value="5">×××™</option>
                            <option value="6">×™×•× ×™</option>
                            <option value="7">×™×•×œ×™</option>
                            <option value="8">××•×’×•×¡×˜</option>
                            <option value="9">×¡×¤×˜××‘×¨</option>
                            <option value="10">××•×§×˜×•×‘×¨</option>
                            <option value="11">× ×•×‘××‘×¨</option>
                            <option value="12">×“×¦××‘×¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>×ª×©×œ×•× ×¢×“ ×—×•×“×© (××ª×™ × ×›× ×¡ ×œ×‘× ×§)</label>
                        <select class="form-control" id="salaryToMonth">
                            <option value="1">×™× ×•××¨</option>
                            <option value="2">×¤×‘×¨×•××¨</option>
                            <option value="3">××¨×¥</option>
                            <option value="4">××¤×¨×™×œ</option>
                            <option value="5">×××™</option>
                            <option value="6">×™×•× ×™</option>
                            <option value="7">×™×•×œ×™</option>
                            <option value="8">××•×’×•×¡×˜</option>
                            <option value="9">×¡×¤×˜××‘×¨</option>
                            <option value="10">××•×§×˜×•×‘×¨</option>
                            <option value="11">× ×•×‘××‘×¨</option>
                            <option value="12">×“×¦××‘×¨</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>×¡×”"×› ×‘×¨×•×˜×• ×œ×ª×§×•×¤×” (â‚ª)</label>
                    <input type="number" class="form-control" id="salaryGross" placeholder="×¡×›×•× ××¦×˜×‘×¨ ××›×œ ×”×ª×œ×•×©×™× - ×œ×¤×™ ×˜×•×¤×¡ 106">
                </div>
                <div class="form-group">
                    <label>×¡×”"×› ××¡ ×”×›× ×¡×” ×©× ×•×›×” (â‚ª)</label>
                    <input type="number" class="form-control" id="salaryTaxDeducted" placeholder="×¡×›×•× ××¦×˜×‘×¨">
                </div>
                <div class="form-group">
                    <label>×¡×”"×› ×‘×™×˜×•×— ×œ××•××™ ×©× ×•×›×” (â‚ª)</label>
                    <input type="number" class="form-control" id="salaryBLDeducted" placeholder="×¡×›×•× ××¦×˜×‘×¨">
                </div>
                <div class="form-group">
                    <label>ğŸ“ ×”×¢×¨×•×ª</label>
                    <input type="text" class="form-control" id="salaryNotes" placeholder="×ª×œ×•×© ×©×›×¨ / ×˜×•×¤×¡ 106">
                </div>
                <div class="form-group">
                    <label>ğŸ“„ ×¦×¨×£ ××¡××š</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="file" id="salaryFile" accept=".pdf,.jpg,.jpeg,.png" style="flex:1;">
                        <span id="salaryFileStatus" style="font-size:0.85rem;color:var(--text-muted);"></span>
                    </div>
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-top:5px;">
                        ×™×™×©××¨ ×‘×ª×™×§×™×™×”: ×©×›×™×¨/ (××§×•××™ + Google Drive)
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addSalary()">×©××•×¨</button>
                <button class="btn" onclick="closeModal('salaryModal')">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="unemploymentModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ“‹ ×”×•×¡×£ ×ª×§×•×¤×ª ××‘×˜×œ×”</h3>
                <button class="btn-icon" onclick="closeModal('unemploymentModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="info-box warning" style="margin-bottom:15px;">
                    <strong>âš ï¸ ×¢×§×¨×•×Ÿ ×”××–×•××Ÿ:</strong> ×”×–×Ÿ ×œ×¤×™ ××•×¢×“ ×”×ª×©×œ×•× ×‘×¤×•×¢×œ (××ª×™ × ×›× ×¡ ×œ×‘× ×§)
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>×ª×©×œ×•× ××—×•×“×©</label>
                        <select class="form-control" id="unemploymentFromMonth">
                            <option value="1">×™× ×•××¨</option>
                            <option value="2">×¤×‘×¨×•××¨</option>
                            <option value="3">××¨×¥</option>
                            <option value="4">××¤×¨×™×œ</option>
                            <option value="5">×××™</option>
                            <option value="6">×™×•× ×™</option>
                            <option value="7">×™×•×œ×™</option>
                            <option value="8">××•×’×•×¡×˜</option>
                            <option value="9">×¡×¤×˜××‘×¨</option>
                            <option value="10">××•×§×˜×•×‘×¨</option>
                            <option value="11">× ×•×‘××‘×¨</option>
                            <option value="12">×“×¦××‘×¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>×ª×©×œ×•× ×¢×“ ×—×•×“×©</label>
                        <select class="form-control" id="unemploymentToMonth">
                            <option value="1">×™× ×•××¨</option>
                            <option value="2">×¤×‘×¨×•××¨</option>
                            <option value="3">××¨×¥</option>
                            <option value="4">××¤×¨×™×œ</option>
                            <option value="5">×××™</option>
                            <option value="6">×™×•× ×™</option>
                            <option value="7">×™×•×œ×™</option>
                            <option value="8">××•×’×•×¡×˜</option>
                            <option value="9">×¡×¤×˜××‘×¨</option>
                            <option value="10">××•×§×˜×•×‘×¨</option>
                            <option value="11">× ×•×‘××‘×¨</option>
                            <option value="12">×“×¦××‘×¨</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>×¡×”"×› ×“××™ ××‘×˜×œ×” ×‘×¨×•×˜×• (â‚ª)</label>
                    <input type="number" class="form-control" id="unemploymentGross">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>××¡ ×©× ×•×›×” (â‚ª)</label>
                        <input type="number" class="form-control" id="unemploymentTaxDeducted">
                    </div>
                    <div class="form-group">
                        <label>×‘×™×˜"×œ ×©× ×•×›×” (â‚ª)</label>
                        <input type="number" class="form-control" id="unemploymentBLDeducted">
                    </div>
                </div>
                <div class="form-group">
                    <label>ğŸ“ ×”×¢×¨×•×ª</label>
                    <input type="text" class="form-control" id="unemploymentNotes" placeholder="×œ×“×•×’××”: ××™×©×•×¨ ×©× ×ª×™ ××‘×™×˜×•×— ×œ××•××™">
                </div>
                <div class="form-group">
                    <label>ğŸ“„ ×¦×¨×£ ××™×©×•×¨ ××‘×™×˜×•×— ×œ××•××™</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="file" id="unemploymentFile" accept=".pdf,.jpg,.jpeg,.png" style="flex:1;">
                        <span id="unemploymentFileStatus" style="font-size:0.85rem;color:var(--text-muted);"></span>
                    </div>
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-top:5px;">
                        ×™×™×©××¨ ×‘×ª×™×§×™×™×”: ××‘×˜×œ×”/
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addUnemployment()">×©××•×¨</button>
                <button class="btn" onclick="closeModal('unemploymentModal')">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="miluimModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ–ï¸ ×”×•×¡×£ ×ª×§×•×¤×ª ××™×œ×•××™×</h3>
                <button class="btn-icon" onclick="closeModal('miluimModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>××ª××¨×™×š</label>
                        <input type="date" class="form-control" id="miluimFrom">
                    </div>
                    <div class="form-group">
                        <label>×¢×“ ×ª××¨×™×š</label>
                        <input type="date" class="form-control" id="miluimTo">
                    </div>
                </div>
                <div class="form-group">
                    <label>××¡×¤×¨ ×™××™ ××™×œ×•××™×</label>
                    <input type="number" class="form-control" id="miluimDays" placeholder="×œ××©×œ: 30">
                </div>
                <div class="form-group">
                    <label>×¡×›×•× ×‘×¨×•×˜×• ×©×”×ª×§×‘×œ (â‚ª)</label>
                    <input type="number" class="form-control" id="miluimAmount" placeholder="×¡×›×•× ×œ×¤× ×™ × ×™×›×•×™×™×">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>××¡ ×”×›× ×¡×” ×©× ×•×›×” (â‚ª)</label>
                        <input type="number" class="form-control" id="miluimTaxDeducted" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>×‘×™×˜"×œ ×©× ×•×›×” (â‚ª)</label>
                        <input type="number" class="form-control" id="miluimBLDeducted" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>ğŸ“ ×”×¢×¨×•×ª</label>
                    <input type="text" class="form-control" id="miluimNotes" placeholder="×œ×“×•×’××”: ××™×©×•×¨ ××‘×™×˜×•×— ×œ××•××™">
                </div>
                <div class="form-group">
                    <label>ğŸ“„ ×¦×¨×£ ××™×©×•×¨ ××™×œ×•××™×</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="file" id="miluimFile" accept=".pdf,.jpg,.jpeg,.png" style="flex:1;">
                        <span id="miluimFileStatus" style="font-size:0.85rem;color:var(--text-muted);"></span>
                    </div>
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-top:5px;">
                        ×™×™×©××¨ ×‘×ª×™×§×™×™×”: ××™×œ×•××™×/
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addMiluim()">×©××•×¨</button>
                <button class="btn" onclick="closeModal('miluimModal')">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="selfEmployedModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ’° ×”×•×¡×£ ×”×›× ×¡×” ×›×¢×¦×××™</h3>
                <button class="btn-icon" onclick="closeModal('selfEmployedModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>×—×•×“×©</label>
                    <select class="form-control" id="selfMonth">
                        <option value="1">×™× ×•××¨</option>
                        <option value="2">×¤×‘×¨×•××¨</option>
                        <option value="3">××¨×¥</option>
                        <option value="4">××¤×¨×™×œ</option>
                        <option value="5">×××™</option>
                        <option value="6">×™×•× ×™</option>
                        <option value="7">×™×•×œ×™</option>
                        <option value="8">××•×’×•×¡×˜</option>
                        <option value="9">×¡×¤×˜××‘×¨</option>
                        <option value="10">××•×§×˜×•×‘×¨</option>
                        <option value="11">× ×•×‘××‘×¨</option>
                        <option value="12">×“×¦××‘×¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×ª×™××•×¨</label>
                    <input type="text" class="form-control" id="selfDescription" placeholder="×œ××©×œ: ×¤×¨×•×™×§×˜ ×¢×™×¦×•×‘">
                </div>
                <div class="form-group">
                    <label>×¡×›×•× (â‚ª)</label>
                    <input type="number" class="form-control" id="selfAmount">
                </div>
                <div class="form-group">
                    <label>ğŸ“ ×”×¢×¨×•×ª</label>
                    <input type="text" class="form-control" id="selfNotes" placeholder="×œ×“×•×’××”: ×—×©×‘×•× ×™×ª ××¡' 001">
                </div>
                <div class="form-group">
                    <label>ğŸ“„ ×¦×¨×£ ×—×©×‘×•× ×™×ª</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="file" id="selfFile" accept=".pdf,.jpg,.jpeg,.png" style="flex:1;">
                        <span id="selfFileStatus" style="font-size:0.85rem;color:var(--text-muted);"></span>
                    </div>
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-top:5px;">
                        ×™×™×©××¨ ×‘×ª×™×§×™×™×”: ×—×©×‘×•× ×™×•×ª-×¢×¦×××™/
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addSelfEmployed()">×©××•×¨</button>
                <button class="btn" onclick="closeModal('selfEmployedModal')">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="expenseModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ§¾ ×”×•×¡×£ ×”×•×¦××” ××•×›×¨×ª</h3>
                <button class="btn-icon" onclick="closeModal('expenseModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>×ª××¨×™×š</label>
                    <input type="date" class="form-control" id="expenseDate">
                </div>
                <div class="form-group">
                    <label>×ª×™××•×¨</label>
                    <input type="text" class="form-control" id="expenseDesc">
                </div>
                <div class="form-group">
                    <label>×§×˜×’×•×¨×™×”</label>
                    <select class="form-control" id="expenseCategory">
                        <option value="×¦×™×•×“">×¦×™×•×“</option>
                        <option value="×ª×•×›× ×”">×ª×•×›× ×” ×•×× ×•×™×™×</option>
                        <option value="× ×¡×™×¢×•×ª">× ×¡×™×¢×•×ª</option>
                        <option value="×˜×œ×¤×•×Ÿ">×˜×œ×¤×•×Ÿ ×•××™× ×˜×¨× ×˜</option>
                        <option value="××©×¨×“">×”×•×¦××•×ª ××©×¨×“</option>
                        <option value="×©×™×•×•×§">×©×™×•×•×§</option>
                        <option value="××§×¦×•×¢×™">×©×™×¨×•×ª×™× ××§×¦×•×¢×™×™×</option>
                        <option value="××—×¨">××—×¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×¡×›×•× (â‚ª)</label>
                    <input type="number" class="form-control" id="expenseAmount">
                </div>
                <div class="form-group">
                    <label>ğŸ“ ×”×¢×¨×•×ª</label>
                    <input type="text" class="form-control" id="expenseNotes" placeholder="×œ×“×•×’××”: ×§×‘×œ×” ××¡' 123">
                </div>
                <div class="form-group">
                    <label>ğŸ“„ ×¦×¨×£ ×§×‘×œ×”/×—×©×‘×•× ×™×ª</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="file" id="expenseFile" accept=".pdf,.jpg,.jpeg,.png" style="flex:1;">
                        <span id="expenseFileStatus" style="font-size:0.85rem;color:var(--text-muted);"></span>
                    </div>
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-top:5px;">
                        ×™×™×©××¨ ×‘×ª×™×§×™×™×”: ×”×•×¦××•×ª-××•×›×¨×•×ª/
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addExpense()">×©××•×¨</button>
                <button class="btn" onclick="closeModal('expenseModal')">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="vatModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ“Š ×”×•×¡×£ ×“×™×•×•×— ××¢"×</h3>
                <button class="btn-icon" onclick="closeModal('vatModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>×ª×§×•×¤×ª ×“×™×•×•×—</label>
                    <select class="form-control" id="vatPeriod">
                        <option value="1-2">×™× ×•××¨-×¤×‘×¨×•××¨</option>
                        <option value="3-4">××¨×¥-××¤×¨×™×œ</option>
                        <option value="5-6">×××™-×™×•× ×™</option>
                        <option value="7-8">×™×•×œ×™-××•×’×•×¡×˜</option>
                        <option value="9-10">×¡×¤×˜××‘×¨-××•×§×˜×•×‘×¨</option>
                        <option value="11-12">× ×•×‘××‘×¨-×“×¦××‘×¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×¡×”"×› ×”×›× ×¡×•×ª (×œ×¤× ×™ ××¢"×)</label>
                    <input type="number" class="form-control" id="vatIncomeAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>××¢"× ×¢×¡×§××•×ª (×¢×œ ×”×›× ×¡×•×ª)</label>
                    <input type="number" class="form-control" id="vatOutputAmount" placeholder="0 - ×™×¦×•× ×œ×—×•''×œ">
                </div>
                <div class="form-group">
                    <label>×¡×”"×› ×”×•×¦××•×ª (×œ×¤× ×™ ××¢"×)</label>
                    <input type="number" class="form-control" id="vatExpenseAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>××¢"× ×ª×©×•××•×ª (×¢×œ ×”×•×¦××•×ª - ×œ×§×™×–×•×–)</label>
                    <input type="number" class="form-control" id="vatInputAmount" placeholder="17% ××”×”×•×¦××•×ª">
                </div>
                <div class="form-group">
                    <label>ğŸ“ ×”×¢×¨×•×ª</label>
                    <input type="text" class="form-control" id="vatNotes" placeholder="××¡××›×ª× / ××¡×¤×¨ ×“×™×•×•×—">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addVatReport()">×©××•×¨</button>
                <button class="btn" onclick="closeModal('vatModal')">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="taxAdvanceModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ›ï¸ ×”×•×¡×£ ××§×“××ª ××¡ ×”×›× ×¡×”</h3>
                <button class="btn-icon" onclick="closeModal('taxAdvanceModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>×¢×‘×•×¨ ×—×•×“×©</label>
                    <select class="form-control" id="taxAdvanceMonth">
                        <option value="1">×™× ×•××¨</option>
                        <option value="2">×¤×‘×¨×•××¨</option>
                        <option value="3">××¨×¥</option>
                        <option value="4">××¤×¨×™×œ</option>
                        <option value="5">×××™</option>
                        <option value="6">×™×•× ×™</option>
                        <option value="7">×™×•×œ×™</option>
                        <option value="8">××•×’×•×¡×˜</option>
                        <option value="9">×¡×¤×˜××‘×¨</option>
                        <option value="10">××•×§×˜×•×‘×¨</option>
                        <option value="11">× ×•×‘××‘×¨</option>
                        <option value="12">×“×¦××‘×¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×¡×›×•× (â‚ª)</label>
                    <input type="number" class="form-control" id="taxAdvanceAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>ğŸ“ ×”×¢×¨×•×ª / ××¡××›×ª×</label>
                    <input type="text" class="form-control" id="taxAdvanceNotes" placeholder="××¡×¤×¨ ××¡××›×ª× / ×©×•×‘×¨">
                </div>
                <div class="form-group">
                    <label>ğŸ“„ ×¦×¨×£ ××™×©×•×¨ ×ª×©×œ×•×</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="file" id="taxAdvanceFile" accept=".pdf,.jpg,.jpeg,.png" style="flex:1;">
                        <span id="taxAdvanceFileStatus" style="font-size:0.85rem;color:var(--text-muted);"></span>
                    </div>
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-top:5px;">
                        ×™×™×©××¨ ×‘×ª×™×§×™×™×”: ××§×“××•×ª-××¡/
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addTaxAdvance()">×©××•×¨</button>
                <button class="btn" onclick="closeModal('taxAdvanceModal')">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="blAdvanceModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ¥ ×”×•×¡×£ ×ª×©×œ×•× ×‘×™×˜×•×— ×œ××•××™</h3>
                <button class="btn-icon" onclick="closeModal('blAdvanceModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>×¢×‘×•×¨ ×—×•×“×©</label>
                    <select class="form-control" id="blAdvanceMonth">
                        <option value="1">×™× ×•××¨</option>
                        <option value="2">×¤×‘×¨×•××¨</option>
                        <option value="3">××¨×¥</option>
                        <option value="4">××¤×¨×™×œ</option>
                        <option value="5">×××™</option>
                        <option value="6">×™×•× ×™</option>
                        <option value="7">×™×•×œ×™</option>
                        <option value="8">××•×’×•×¡×˜</option>
                        <option value="9">×¡×¤×˜××‘×¨</option>
                        <option value="10">××•×§×˜×•×‘×¨</option>
                        <option value="11">× ×•×‘××‘×¨</option>
                        <option value="12">×“×¦××‘×¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×¡×›×•× (â‚ª) - ×›×•×œ×œ ××¡ ×‘×¨×™××•×ª</label>
                    <input type="number" class="form-control" id="blAdvanceAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>ğŸ“ ×”×¢×¨×•×ª / ××¡××›×ª×</label>
                    <input type="text" class="form-control" id="blAdvanceNotes" placeholder="××¡×¤×¨ ××¡××›×ª× / ×©×•×‘×¨">
                </div>
                <div class="form-group">
                    <label>ğŸ“„ ×¦×¨×£ ××™×©×•×¨ ×ª×©×œ×•×</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="file" id="blAdvanceFile" accept=".pdf,.jpg,.jpeg,.png" style="flex:1;">
                        <span id="blAdvanceFileStatus" style="font-size:0.85rem;color:var(--text-muted);"></span>
                    </div>
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-top:5px;">
                        ×™×™×©××¨ ×‘×ª×™×§×™×™×”: ×‘×™×˜×•×—-×œ××•××™/
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addBLAdvance()">×©××•×¨</button>
                <button class="btn" onclick="closeModal('blAdvanceModal')">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="yearModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ“… × ×™×”×•×œ ×©× ×™×</h3>
                <button class="btn-icon" onclick="closeModal('yearModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>×”×•×¡×£ ×©× ×” ×—×“×©×”</label>
                    <div style="display:flex;gap:10px;">
                        <input type="number" class="form-control" id="newYearInput" placeholder="2026" min="2020" max="2050">
                        <button class="btn btn-primary" onclick="addYear()">×”×•×¡×£</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>×©× ×™× ×§×™×™××•×ª</label>
                    <div id="yearsList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('yearModal')">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="favoritesModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3>â­ ×¢×¨×™×›×ª ××•×¢×“×¤×™×</h3>
                <button class="btn-icon" onclick="closeModal('favoritesModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="info-box" style="margin-bottom:15px;">
                    <strong>ğŸ’¡ ×˜×™×¤×™×:</strong><br>
                    â€¢ ×§×œ×™×§ ×¨×’×™×œ = ×¤×ª×™×—×ª ×”×§×™×©×•×¨<br>
                    â€¢ ×§×œ×™×§ ×™×× ×™ = ×¢×¨×™×›×” ××”×™×¨×”<br>
                    â€¢ ××ª×¨×™×: https://... | ×ª×™×§×™×•×ª: C:\...
                </div>
                <div id="favoritesEditor"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveFavorites()">×©××•×¨</button>
                <button class="btn" onclick="closeModal('favoritesModal')">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="dashboardSettingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ¨ ×”×ª×××ª ×“×©×‘×•×¨×“</h3>
                <button class="btn-icon" onclick="closeModal('dashboardSettingsModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    ×‘×—×¨ ××™×œ×• ×›×¨×˜×™×¡×™×•×ª ×œ×”×¦×™×’ ×‘×“×©×‘×•×¨×“:
                </div>
                <div class="form-group">
                    <label><strong>×”×›× ×¡×•×ª</strong></label>
                    <div class="credit-points-grid">
                        <div class="credit-item">
                            <input type="checkbox" id="dash_salary" checked onchange="saveDashboardSettings()">
                            <label for="dash_salary">ğŸ’¼ ×”×›× ×¡×” ×›×©×›×™×¨</label>
                        </div>
                        <div class="credit-item">
                            <input type="checkbox" id="dash_unemployment" checked onchange="saveDashboardSettings()">
                            <label for="dash_unemployment">ğŸ“‹ ×“××™ ××‘×˜×œ×”</label>
                        </div>
                        <div class="credit-item">
                            <input type="checkbox" id="dash_miluim" checked onchange="saveDashboardSettings()">
                            <label for="dash_miluim">ğŸ–ï¸ ××™×œ×•××™×</label>
                        </div>
                        <div class="credit-item">
                            <input type="checkbox" id="dash_selfemployed" checked onchange="saveDashboardSettings()">
                            <label for="dash_selfemployed">ğŸ’° ×¢×¦×××™</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label><strong>×¡×™×›×•××™×</strong></label>
                    <div class="credit-points-grid">
                        <div class="credit-item">
                            <input type="checkbox" id="dash_totalIncome" checked onchange="saveDashboardSettings()">
                            <label for="dash_totalIncome">ğŸ“ˆ ×¡×”"×› ×”×›× ×¡×” ×—×™×™×‘×ª</label>
                        </div>
                        <div class="credit-item">
                            <input type="checkbox" id="dash_credits" checked onchange="saveDashboardSettings()">
                            <label for="dash_credits">â­ × ×§×•×“×•×ª ×–×™×›×•×™</label>
                        </div>
                        <div class="credit-item">
                            <input type="checkbox" id="dash_taxDue" checked onchange="saveDashboardSettings()">
                            <label for="dash_taxDue">ğŸ›ï¸ ××¡ ××—×•×©×‘</label>
                        </div>
                        <div class="credit-item">
                            <input type="checkbox" id="dash_taxPaid" checked onchange="saveDashboardSettings()">
                            <label for="dash_taxPaid">âœ… ××¡ ×©×©×•×œ×</label>
                        </div>
                        <div class="credit-item">
                            <input type="checkbox" id="dash_blDue" checked onchange="saveDashboardSettings()">
                            <label for="dash_blDue">ğŸ¥ ×‘×™×˜"×œ ××—×•×©×‘</label>
                        </div>
                        <div class="credit-item">
                            <input type="checkbox" id="dash_blPaid" checked onchange="saveDashboardSettings()">
                            <label for="dash_blPaid">ğŸ’³ ×‘×™×˜"×œ ×©×©×•×œ×</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label><strong>×ª×¦×•×’×” × ×•×¡×¤×ª</strong></label>
                    <div class="credit-points-grid">
                        <div class="credit-item">
                            <input type="checkbox" id="dash_paymentsSummary" checked onchange="saveDashboardSettings()">
                            <label for="dash_paymentsSummary">ğŸ“‹ ×¤×™×¨×•×˜ ×ª×©×œ×•××™×</label>
                        </div>
                        <div class="credit-item">
                            <input type="checkbox" id="dash_result" checked onchange="saveDashboardSettings()">
                            <label for="dash_result">ğŸ¯ ×ª×•×¦××” (×”×—×–×¨/×œ×©×œ×)</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('dashboardSettingsModal')">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <script>
        // ========== GOOGLE DRIVE INTEGRATION ==========
        const GOOGLE_CLIENT_ID = '831800526620-vrar20hjjjne49jrr6gpv9dmr54224g5.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyB30a84J6yYYHgRYddgd97vOVIR-r95Z94';
        const DRIVE_FOLDER_NAME = 'john-finance';
        const BACKUP_FILE_NAME = 'tax-data-backup.json';
        let googleAccessToken = null;
        let driveFolderId = null;

        async function initGoogleDrive() {
            // Check if credentials are set
            if (!GOOGLE_CLIENT_ID || !GOOGLE_API_KEY) {
                // Show setup instructions
                alert('âš™ï¸ ×”×’×“×¨×ª Google Drive:\n\n' +
                    '1. ×œ×š ×œ-console.cloud.google.com\n' +
                    '2. ×¦×•×¨ ×¤×¨×•×™×§×˜ ×—×“×©\n' +
                    '3. ×”×¤×¢×œ ××ª Google Drive API\n' +
                    '4. ×¦×•×¨ OAuth 2.0 credentials\n' +
                    '5. ×”×•×¡×£ ××ª ×”-Client ID ×•×”-API Key ×‘×§×•×“\n\n' +
                    '×‘×™× ×ª×™×™×, ××¤×©×¨ ×œ×”×©×ª××© ×‘×’×™×‘×•×™ ××§×•××™ (×™×™×¦×/×™×™×‘×)');
                return;
            }
            
            // Show connecting status
            document.getElementById('driveStatusText').innerHTML = 'â³ ××ª×—×‘×¨ ×œ-Google...';
            
            try {
                console.log('Step 1: Loading Google API...');
                await loadGoogleAPI();
                console.log('Step 2: Google API loaded, authenticating...');
                await authenticateGoogle();
                console.log('Step 3: Authenticated, creating folder...');
                await findOrCreateDriveRootFolder();
                console.log('Step 4: Done!');
                updateDriveStatus(true);
            } catch (error) {
                console.error('Google Drive init error:', error);
                const errorMsg = error.error_description || error.error || error.message || JSON.stringify(error);
                updateDriveStatus(false, errorMsg);
            }
        }
        
        // Find or create john-finance root folder AND full structure
        async function findOrCreateDriveRootFolder() {
            // Find or create root folder
            console.log('Looking for john-finance folder...');
            const search = await gapi.client.drive.files.list({
                q: `name='john-finance' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id)'
            });
            
            if (search.result.files.length > 0) {
                driveFolderId = search.result.files[0].id;
                console.log('Found existing folder:', driveFolderId);
            } else {
                console.log('Creating john-finance folder...');
                const create = await gapi.client.drive.files.create({
                    resource: {
                        name: 'john-finance',
                        mimeType: 'application/vnd.google-apps.folder'
                    },
                    fields: 'id'
                });
                driveFolderId = create.result.id;
                console.log('Created folder:', driveFolderId);
            }
            
            // Create full folder structure automatically
            console.log('Creating folder structure...');
            await createDriveFolderStructure();
            console.log('Folder structure complete!');
        }
        
        // Create full folder structure in Drive
        async function createDriveFolderStructure() {
            const subFolders = [
                '×©×›×™×¨',
                '××§×“××•×ª-××¡',
                '×‘×™×˜×•×—-×œ××•××™',
                '×—×©×‘×•× ×™×•×ª-×¢×¦×××™',
                '×”×•×¦××•×ª-××•×›×¨×•×ª',
                '××™×œ×•××™×',
                '××‘×˜×œ×”'
            ];
            
            // Get years from data - make sure it's loaded
            let years = [];
            if (data && data.years && data.years.length > 0) {
                years = data.years;
            } else {
                // Fallback - try to load from localStorage
                const saved = localStorage.getItem('taxCalculatorV2');
                if (saved) {
                    const savedData = JSON.parse(saved);
                    years = savedData.years || [new Date().getFullYear()];
                } else {
                    years = [new Date().getFullYear()];
                }
            }
            
            console.log('Creating folders for years:', years);
            
            for (const year of years) {
                console.log('Processing year:', year);
                // Find or create year folder
                let yearFolderId;
                const yearSearch = await gapi.client.drive.files.list({
                    q: `name='${year}' and '${driveFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id)'
                });
                
                if (yearSearch.result.files.length > 0) {
                    yearFolderId = yearSearch.result.files[0].id;
                    console.log('Found year folder:', year, yearFolderId);
                } else {
                    console.log('Creating year folder:', year);
                    const yearFolder = await gapi.client.drive.files.create({
                        resource: {
                            name: year.toString(),
                            mimeType: 'application/vnd.google-apps.folder',
                            parents: [driveFolderId]
                        },
                        fields: 'id'
                    });
                    yearFolderId = yearFolder.result.id;
                    console.log('Created year folder:', year, yearFolderId);
                }
                
                // Create subfolders inside year folder
                for (const folderName of subFolders) {
                    const subSearch = await gapi.client.drive.files.list({
                        q: `name='${folderName}' and '${yearFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                        fields: 'files(id)'
                    });
                    
                    if (subSearch.result.files.length === 0) {
                        console.log('Creating subfolder:', folderName);
                        await gapi.client.drive.files.create({
                            resource: {
                                name: folderName,
                                mimeType: 'application/vnd.google-apps.folder',
                                parents: [yearFolderId]
                            }
                        });
                    }
                }
            }
            
            console.log('Drive folder structure created/verified');
        }

        function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                // Load GAPI
                if (!window.gapi) {
                    const gapiScript = document.createElement('script');
                    gapiScript.src = 'https://apis.google.com/js/api.js';
                    gapiScript.onload = () => {
                        gapi.load('client', async () => {
                            await gapi.client.init({
                                apiKey: GOOGLE_API_KEY,
                                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                            });
                            resolve();
                        });
                    };
                    gapiScript.onerror = reject;
                    document.body.appendChild(gapiScript);
                } else {
                    resolve();
                }
            });
        }
        
        function loadGISClient() {
            return new Promise((resolve, reject) => {
                if (window.google?.accounts?.oauth2) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.onload = resolve;
                script.onerror = reject;
                document.body.appendChild(script);
            });
        }

        async function authenticateGoogle() {
            console.log('Loading GIS client...');
            await loadGISClient();
            console.log('GIS client loaded, requesting token...');
            
            return new Promise((resolve, reject) => {
                try {
                    const tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/drive.file',
                        callback: (response) => {
                            console.log('Token response:', response);
                            if (response.error) {
                                console.error('Token error:', response);
                                reject(response);
                                return;
                            }
                            googleAccessToken = response.access_token;
                            console.log('Got access token!');
                            resolve();
                        },
                        error_callback: (error) => {
                            console.error('Error callback:', error);
                            reject(error);
                        }
                    });
                    console.log('Requesting access token...');
                    tokenClient.requestAccessToken();
                } catch (e) {
                    console.error('initTokenClient error:', e);
                    reject(e);
                }
            });
        }

        function updateDriveStatus(connected, error = null) {
            const statusEl = document.getElementById('driveStatusText');
            const backupBtn = document.getElementById('btnBackup');
            const restoreBtn = document.getElementById('btnRestore');
            const createFoldersBtn = document.getElementById('btnCreateDriveFolders');
            
            if (connected) {
                statusEl.innerHTML = 'âœ… ××—×•×‘×¨ ×œ-Google Drive';
                statusEl.style.color = 'var(--success)';
                backupBtn.disabled = false;
                restoreBtn.disabled = false;
                if (createFoldersBtn) createFoldersBtn.disabled = false;
            } else {
                statusEl.innerHTML = 'âŒ ×œ× ××—×•×‘×¨' + (error ? ': ' + error : '');
                statusEl.style.color = 'var(--danger)';
                backupBtn.disabled = true;
                restoreBtn.disabled = true;
                if (createFoldersBtn) createFoldersBtn.disabled = true;
            }
        }

        async function getOrCreateFolder() {
            // Search for existing folder
            const response = await gapi.client.drive.files.list({
                q: `name='${DRIVE_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id, name)'
            });
            
            if (response.result.files.length > 0) {
                return response.result.files[0].id;
            }
            
            // Create new folder
            const createResponse = await gapi.client.drive.files.create({
                resource: {
                    name: DRIVE_FOLDER_NAME,
                    mimeType: 'application/vnd.google-apps.folder'
                },
                fields: 'id'
            });
            
            return createResponse.result.id;
        }

        async function backupToDrive() {
            try {
                document.getElementById('btnBackup').textContent = 'â³ ××’×‘×”...';
                
                const folderId = await getOrCreateFolder();
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                
                // Check if file exists
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${BACKUP_FILE_NAME}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id)'
                });
                
                let url, method;
                const form = new FormData();
                
                if (searchResponse.result.files.length > 0) {
                    // Update existing file
                    const fileId = searchResponse.result.files[0].id;
                    url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart&fields=id`;
                    method = 'PATCH';
                    
                    const metadata = {
                        name: BACKUP_FILE_NAME,
                        mimeType: 'application/json'
                    };
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                } else {
                    // Create new file in folder
                    url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id';
                    method = 'POST';
                    
                    const metadata = {
                        name: BACKUP_FILE_NAME,
                        mimeType: 'application/json',
                        parents: [folderId]  // Include parent folder!
                    };
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                }
                
                form.append('file', blob);
                
                await fetch(url, {
                    method: method,
                    headers: { 'Authorization': 'Bearer ' + googleAccessToken },
                    body: form
                });
                
                const now = new Date().toLocaleString('he-IL');
                document.getElementById('lastSyncTime').textContent = 'ğŸ“… ×’×™×‘×•×™ ××—×¨×•×Ÿ: ' + now;
                localStorage.setItem('lastDriveBackup', now);
                
                document.getElementById('btnBackup').textContent = 'ğŸ“¤ ×’×™×‘×•×™ ×œ-Drive';
                alert('âœ… ×”×’×™×‘×•×™ ×”×•×©×œ× ×‘×”×¦×œ×—×”!');
            } catch (error) {
                console.error('Backup error:', error);
                document.getElementById('btnBackup').textContent = 'ğŸ“¤ ×’×™×‘×•×™ ×œ-Drive';
                alert('âŒ ×©×’×™××” ×‘×’×™×‘×•×™: ' + error.message);
            }
        }

        async function restoreFromDrive() {
            try {
                if (!confirm('âš ï¸ ×©×—×–×•×¨ ×™×—×œ×™×£ ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™×. ×œ×”××©×™×š?')) return;
                
                document.getElementById('btnRestore').textContent = 'â³ ××©×—×–×¨...';
                
                const folderId = await getOrCreateFolder();
                
                // Find backup file
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${BACKUP_FILE_NAME}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id)'
                });
                
                if (searchResponse.result.files.length === 0) {
                    alert('âŒ ×œ× × ××¦× ×§×•×‘×¥ ×’×™×‘×•×™ ×‘-Drive');
                    document.getElementById('btnRestore').textContent = 'ğŸ“¥ ×©×—×–×•×¨ ×-Drive';
                    return;
                }
                
                const fileId = searchResponse.result.files[0].id;
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                data = response.result;
                saveData();
                location.reload();
            } catch (error) {
                console.error('Restore error:', error);
                document.getElementById('btnRestore').textContent = 'ğŸ“¥ ×©×—×–×•×¨ ×-Drive';
                alert('âŒ ×©×’×™××” ×‘×©×—×–×•×¨: ' + error.message);
            }
        }

        async function createFolderStructure() {
            if (!googleAccessToken) {
                alert('âš ï¸ ×™×© ×œ×”×ª×—×‘×¨ ×§×•×“× ×œ-Google Drive');
                return;
            }
            
            try {
                await createDriveFolderStructure();
                alert(`âœ… ××‘× ×” ×”×ª×™×§×™×•×ª × ×•×¦×¨ ×‘×”×¦×œ×—×”!\njohn-finance/\n×¤×ª×— ××ª Google Drive ×›×“×™ ×œ×¨××•×ª.`);
            } catch (error) {
                console.error('Create folders error:', error);
                alert('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×™×§×™×•×ª: ' + error.message);
            }
        }

        // Check for last backup time on load
        function checkLastBackup() {
            const lastBackup = localStorage.getItem('lastDriveBackup');
            if (lastBackup) {
                document.getElementById('lastSyncTime').textContent = 'ğŸ“… ×’×™×‘×•×™ ××—×¨×•×Ÿ: ' + lastBackup;
            }
        }

        // ========== FAVORITES MANAGEMENT ==========
        const DEFAULT_FAVORITES = [
            { name: '××¡ ×”×›× ×¡×”', icon: 'ğŸ›ï¸', url: 'https://www.gov.il/he/departments/israel_tax_authority' },
            { name: '×‘×™×˜×•×— ×œ××•××™', icon: 'ğŸ¥', url: 'https://www.btl.gov.il/' },
            { name: '××¢"×', icon: 'ğŸ“Š', url: 'https://www.gov.il/he/service/vat-reports' },
            { name: '×—×©×‘×©×‘×ª', icon: 'ğŸ§®', url: 'https://www.hashavshevet.co.il/' },
            { name: '×”×’×“×¨...', icon: 'âš™ï¸', url: '' }
        ];
        
        function loadFavorites() {
            const saved = localStorage.getItem('johnFinanceFavorites');
            const favorites = saved ? JSON.parse(saved) : DEFAULT_FAVORITES;
            
            for (let i = 1; i <= 5; i++) {
                const fav = favorites[i - 1] || DEFAULT_FAVORITES[i - 1];
                const btn = document.getElementById('fav' + i);
                if (btn) {
                    btn.querySelector('.fav-icon').textContent = fav.icon;
                    btn.querySelector('.fav-name').textContent = fav.name;
                    btn.title = fav.url || '×§×œ×™×§ ×™×× ×™ ×œ×¢×¨×™×›×”';
                }
            }
        }
        
        function getFavorites() {
            const saved = localStorage.getItem('johnFinanceFavorites');
            return saved ? JSON.parse(saved) : [...DEFAULT_FAVORITES];
        }
        
        function openFavorite(index) {
            const favorites = getFavorites();
            const fav = favorites[index - 1];
            
            if (!fav.url) {
                openModal('favoritesModal');
                renderFavoritesEditor();
                return;
            }
            
            // Open URL in new tab
            window.open(fav.url, '_blank');
        }
        
        function editFavorite(event, index) {
            event.preventDefault();
            openModal('favoritesModal');
            renderFavoritesEditor();
            // Focus on the specific favorite
            setTimeout(() => {
                const input = document.getElementById('favName' + index);
                if (input) input.focus();
            }, 100);
        }
        
        function renderFavoritesEditor() {
            const favorites = getFavorites();
            const container = document.getElementById('favoritesEditor');
            
            container.innerHTML = favorites.map((fav, idx) => `
                <div style="margin-bottom:15px;padding:15px;background:var(--bg-input);border-radius:8px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                        <span style="font-size:1.2rem;">${idx + 1}.</span>
                        <input type="text" class="form-control" id="favIcon${idx + 1}" value="${fav.icon}" 
                            style="width:50px;text-align:center;font-size:1.2rem;" maxlength="2" placeholder="ğŸ”—">
                        <input type="text" class="form-control" id="favName${idx + 1}" value="${fav.name}" 
                            style="flex:1;" placeholder="×©× ×”×§×™×©×•×¨">
                    </div>
                    <input type="text" class="form-control" id="favUrl${idx + 1}" value="${fav.url}" 
                        placeholder="https://... ××• C:\\×ª×™×§×™×™×”\\..." dir="ltr">
                </div>
            `).join('');
        }
        
        function saveFavorites() {
            const favorites = [];
            
            for (let i = 1; i <= 5; i++) {
                favorites.push({
                    icon: document.getElementById('favIcon' + i).value || 'ğŸ”—',
                    name: document.getElementById('favName' + i).value || '××•×¢×“×£ ' + i,
                    url: document.getElementById('favUrl' + i).value || ''
                });
            }
            
            localStorage.setItem('johnFinanceFavorites', JSON.stringify(favorites));
            loadFavorites();
            closeModal('favoritesModal');
        }

        // ========== LOCAL FOLDER MANAGEMENT ==========
        const FOLDER_STRUCTURE = [
            '×©×›×™×¨',
            '××§×“××•×ª-××¡', 
            '×‘×™×˜×•×—-×œ××•××™',
            '×—×©×‘×•× ×™×•×ª-×¢×¦×××™',
            '×”×•×¦××•×ª-××•×›×¨×•×ª',
            '××™×œ×•××™×',
            '××‘×˜×œ×”'
        ];
        
        let localFolderHandle = null;
        const DB_NAME = 'johnFinanceDB';
        const DB_VERSION = 1;
        
        // Check if File System Access API is supported
        function isFileSystemSupported() {
            return 'showDirectoryPicker' in window;
        }
        
        // Initialize IndexedDB for storing folder handle
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }
        
        // Save folder handle to IndexedDB
        async function saveFolderHandle(handle) {
            const db = await initIndexedDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('settings', 'readwrite');
                const store = tx.objectStore('settings');
                store.put({ key: 'localFolderHandle', value: handle });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }
        
        // Load folder handle from IndexedDB
        async function loadFolderHandle() {
            try {
                const db = await initIndexedDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('settings', 'readonly');
                    const store = tx.objectStore('settings');
                    const request = store.get('localFolderHandle');
                    request.onsuccess = () => resolve(request.result?.value || null);
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('Error loading folder handle:', e);
                return null;
            }
        }
        
        // Select local folder
        async function selectLocalFolder() {
            if (!isFileSystemSupported()) {
                document.getElementById('localFolderBrowserWarning').style.display = 'block';
                return;
            }
            
            try {
                const handle = await window.showDirectoryPicker({
                    mode: 'readwrite'
                });
                
                localFolderHandle = handle;
                await saveFolderHandle(handle);
                updateLocalFolderUI();
                
            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('Folder selection error:', e);
                    alert('âŒ ×©×’×™××” ×‘×‘×—×™×¨×ª ×ª×™×§×™×™×”: ' + e.message);
                }
            }
        }
        
        // Update UI with folder status
        function updateLocalFolderUI() {
            const pathEl = document.getElementById('localFolderPath');
            const hintEl = document.getElementById('localFolderHint');
            const iconEl = document.getElementById('localFolderIcon');
            const btnCreate = document.getElementById('btnCreateLocalFolders');
            const btnOpen = document.getElementById('btnOpenLocalFolder');
            const btnRestore = document.getElementById('btnRestoreLocal');
            
            if (localFolderHandle) {
                pathEl.textContent = localFolderHandle.name + '/john-finance/';
                hintEl.textContent = 'âœ… ×ª×™×§×™×™×” × ×‘×—×¨×” - × ×ª×•× ×™× × ×©××¨×™× ××•×˜×•××˜×™×ª';
                hintEl.style.color = 'var(--success)';
                iconEl.textContent = 'ğŸ“‚';
                btnCreate.disabled = false;
                btnOpen.disabled = false;
                btnRestore.disabled = false;
            } else {
                pathEl.textContent = '×œ× × ×‘×—×¨×” ×ª×™×§×™×™×”';
                hintEl.textContent = '×‘×—×¨ ×ª×™×§×™×™×” ×œ×©××™×¨×ª ×”××¡××›×™×';
                hintEl.style.color = 'var(--text-muted)';
                iconEl.textContent = 'ğŸ“';
                btnCreate.disabled = true;
                btnOpen.disabled = true;
                btnRestore.disabled = true;
            }
        }
        
        // Manual restore from local folder
        async function restoreFromLocalFolder() {
            if (!localFolderHandle) {
                alert('âš ï¸ ×™×© ×œ×‘×—×•×¨ ×ª×™×§×™×™×” ×§×•×“×');
                return;
            }
            
            const localData = await loadDataFromLocalFolder();
            if (localData) {
                if (confirm('âš ï¸ ×©×—×–×•×¨ ×™×—×œ×™×£ ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™×.\n\n×œ×”××©×™×š?')) {
                    data = localData;
                    localStorage.setItem('taxCalculatorV2', JSON.stringify(data));
                    renderYearSelector();
                    renderAll();
                    alert('âœ… ×”× ×ª×•× ×™× ×©×•×—×–×¨×• ×‘×”×¦×œ×—×” ××”×ª×™×§×™×™×” ×”××§×•××™×ª!');
                }
            } else {
                alert('âŒ ×œ× × ××¦× ×§×•×‘×¥ data.json ×‘×ª×™×§×™×™×” john-finance/');
            }
        }
        
        // Create folder structure locally
        async function createLocalFolderStructure() {
            if (!localFolderHandle) {
                alert('âš ï¸ ×™×© ×œ×‘×—×•×¨ ×ª×™×§×™×™×” ×§×•×“×');
                return;
            }
            
            try {
                // Verify we still have permission
                const permission = await localFolderHandle.requestPermission({ mode: 'readwrite' });
                if (permission !== 'granted') {
                    alert('âŒ ××™×Ÿ ×”×¨×©××” ×œ×›×ª×•×‘ ×œ×ª×™×§×™×™×”');
                    return;
                }
                
                // Create john-finance root folder
                const rootFolder = await localFolderHandle.getDirectoryHandle('john-finance', { create: true });
                
                // Create year folders inside john-finance
                for (const year of (data.years || [currentYear])) {
                    const yearFolder = await rootFolder.getDirectoryHandle(String(year), { create: true });
                    
                    // Create subfolders
                    for (const subFolder of FOLDER_STRUCTURE) {
                        await yearFolder.getDirectoryHandle(subFolder, { create: true });
                    }
                }
                
                alert(`âœ… ××‘× ×” ×”×ª×™×§×™×•×ª × ×•×¦×¨ ×‘×”×¦×œ×—×”!\n\n${localFolderHandle.name}/john-finance/\nâ”œâ”€â”€ ${(data.years || [currentYear]).join('/\nâ”œâ”€â”€ ')}/\n    â””â”€â”€ [×ª×™×§×™×•×ª ××¡××›×™×]`);
                
            } catch (e) {
                console.error('Create local folders error:', e);
                alert('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×™×§×™×•×ª: ' + e.message);
            }
        }
        
        // Copy local folder path to clipboard
        async function openLocalFolder() {
            if (localFolderHandle) {
                const path = `${localFolderHandle.name}\\john-finance`;
                try {
                    await navigator.clipboard.writeText(path);
                    alert(`ğŸ“‹ ×”× ×ª×™×‘ ×”×•×¢×ª×§ ×œ×œ×•×—!\n\n${path}\n\n×¤×ª×— ××ª ×¡×™×™×¨ ×”×§×‘×¦×™× ×•×”×“×‘×§ ×‘×©×•×¨×ª ×”×›×ª×•×‘×ª.`);
                } catch (e) {
                    alert(`ğŸ“ ×ª×™×§×™×™×”: ${path}\n\n×”×¢×ª×§ ×™×“× ×™×ª ×•×¤×ª×— ×‘×¡×™×™×¨ ×”×§×‘×¦×™×.`);
                }
            }
        }
        
        // Save file to local folder
        async function saveFileLocally(file, subFolder, year = currentYear) {
            if (!localFolderHandle) return null;
            
            try {
                const permission = await localFolderHandle.requestPermission({ mode: 'readwrite' });
                if (permission !== 'granted') return null;
                
                // Get or create john-finance root folder
                const rootFolder = await localFolderHandle.getDirectoryHandle('john-finance', { create: true });
                
                // Get or create year folder
                const yearFolder = await rootFolder.getDirectoryHandle(String(year), { create: true });
                
                // Get or create subfolder
                const targetFolder = await yearFolder.getDirectoryHandle(subFolder, { create: true });
                
                // Create file
                const fileHandle = await targetFolder.getFileHandle(file.name, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(file);
                await writable.close();
                
                return `${localFolderHandle.name}/john-finance/${year}/${subFolder}/${file.name}`;
            } catch (e) {
                console.error('Save file locally error:', e);
                return null;
            }
        }
        
        // Upload file to Google Drive folder
        async function uploadFileToDrive(file, subFolder, year = currentYear) {
            if (!googleAccessToken || !driveFolderId) return null;
            
            try {
                // Find or create year folder
                let yearFolderId = await findOrCreateDriveFolder(String(year), driveFolderId);
                
                // Find or create subfolder
                let subFolderId = await findOrCreateDriveFolder(subFolder, yearFolderId);
                
                // Upload file
                const metadata = {
                    name: file.name,
                    parents: [subFolderId]
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
                
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + googleAccessToken
                    },
                    body: form
                });
                
                const result = await response.json();
                return result.id ? { id: result.id, link: result.webViewLink } : null;
                
            } catch (e) {
                console.error('Upload to Drive error:', e);
                return null;
            }
        }
        
        // Helper: find or create Drive folder
        async function findOrCreateDriveFolder(name, parentId) {
            const search = await gapi.client.drive.files.list({
                q: `name='${name}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id)'
            });
            
            if (search.result.files.length > 0) {
                return search.result.files[0].id;
            }
            
            const create = await gapi.client.drive.files.create({
                resource: {
                    name: name,
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [parentId]
                },
                fields: 'id'
            });
            
            return create.result.id;
        }
        
        // Upload file to BOTH local and Drive
        async function uploadDocument(file, subFolder, recordType, recordId) {
            const results = { local: null, drive: null };
            
            // Save locally
            if (localFolderHandle) {
                results.local = await saveFileLocally(file, subFolder);
            }
            
            // Upload to Drive
            if (googleAccessToken && driveFolderId) {
                results.drive = await uploadFileToDrive(file, subFolder);
            }
            
            // Store reference in data
            if (results.local || results.drive) {
                const yd = getYearData();
                if (!yd.documents) yd.documents = [];
                
                yd.documents.push({
                    id: Date.now(),
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type,
                    subFolder: subFolder,
                    recordType: recordType,
                    recordId: recordId,
                    localPath: results.local,
                    driveId: results.drive?.id,
                    driveLink: results.drive?.link,
                    uploadDate: new Date().toISOString()
                });
                
                saveData();
            }
            
            return results;
        }
        
        // Initialize local folder on page load
        async function initLocalFolder() {
            if (!isFileSystemSupported()) {
                document.getElementById('localFolderBrowserWarning').style.display = 'block';
                return;
            }
            
            const handle = await loadFolderHandle();
            if (handle) {
                try {
                    // Verify permission
                    const permission = await handle.queryPermission({ mode: 'readwrite' });
                    if (permission === 'granted') {
                        localFolderHandle = handle;
                        // Try to restore data if localStorage is empty
                        await tryRestoreFromLocal();
                    } else {
                        // Need to re-request permission
                        localFolderHandle = handle;
                    }
                } catch (e) {
                    console.error('Error verifying folder handle:', e);
                }
            }
            updateLocalFolderUI();
        }

        // ========== YEAR MANAGEMENT ==========
        function renderYearSelector() {
            const select = document.getElementById('currentYear');
            if (!data.years || data.years.length === 0) data.years = [2025, 2024];
            
            // Sort years descending
            const sortedYears = [...data.years].sort((a, b) => b - a);
            
            // Make sure currentYear is one of the available years
            if (!sortedYears.includes(currentYear)) {
                currentYear = sortedYears[0];
            }
            
            select.innerHTML = sortedYears.map(y => 
                `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`
            ).join('');
            
            // Ensure the select value matches currentYear
            select.value = currentYear;
        }

        function renderYearsList() {
            const container = document.getElementById('yearsList');
            if (!container) return;
            
            if (!data.years) data.years = [2025, 2024];
            const sortedYears = [...data.years].sort((a, b) => b - a);
            
            container.innerHTML = sortedYears.map(y => `
                <div class="breakdown-item" style="margin-bottom:5px;">
                    <span>${y}</span>
                    <button class="btn btn-icon btn-sm" onclick="deleteYear(${y})" title="××—×§">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        }

        function addYear() {
            const input = document.getElementById('newYearInput');
            const year = parseInt(input.value);
            
            if (!year || year < 2020 || year > 2050) {
                alert('×©× ×” ×œ× ×ª×§×™× ×”');
                return;
            }
            
            if (!data.years) data.years = [2025, 2024];
            
            if (data.years.includes(year)) {
                alert('×©× ×” ×›×‘×¨ ×§×™×™××ª');
                return;
            }
            
            data.years.push(year);
            saveData();
            renderYearSelector();
            renderYearsList();
            input.value = '';
        }

        function deleteYear(year) {
            if (data.years.length <= 1) {
                alert('×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª ×©× ×” ××—×ª');
                return;
            }
            
            if (confirm(`×œ××—×•×§ ××ª ×©× ×ª ${year}?`)) {
                data.years = data.years.filter(y => y !== year);
                saveData();
                
                // If deleted current year, switch to another
                if (currentYear === year) {
                    currentYear = data.years[0];
                    document.getElementById('currentYear').value = currentYear;
                }
                
                renderYearSelector();
                renderYearsList();
                renderAll();
            }
        }

        // ========== DASHBOARD SETTINGS ==========
        function loadDashboardSettings() {
            if (!data.dashboardSettings) {
                data.dashboardSettings = {
                    salary: true,
                    unemployment: true,
                    miluim: true,
                    selfemployed: true,
                    totalIncome: true,
                    credits: true,
                    taxDue: true,
                    taxPaid: true,
                    blDue: true,
                    blPaid: true,
                    paymentsSummary: true,
                    result: true
                };
            }
            
            // Load checkboxes
            Object.keys(data.dashboardSettings).forEach(key => {
                const checkbox = document.getElementById('dash_' + key);
                if (checkbox) {
                    checkbox.checked = data.dashboardSettings[key];
                }
            });
            
            applyDashboardSettings();
        }

        function saveDashboardSettings() {
            data.dashboardSettings = {
                salary: document.getElementById('dash_salary').checked,
                unemployment: document.getElementById('dash_unemployment').checked,
                miluim: document.getElementById('dash_miluim').checked,
                selfemployed: document.getElementById('dash_selfemployed').checked,
                totalIncome: document.getElementById('dash_totalIncome').checked,
                credits: document.getElementById('dash_credits').checked,
                taxDue: document.getElementById('dash_taxDue').checked,
                taxPaid: document.getElementById('dash_taxPaid').checked,
                blDue: document.getElementById('dash_blDue').checked,
                blPaid: document.getElementById('dash_blPaid').checked,
                paymentsSummary: document.getElementById('dash_paymentsSummary').checked,
                result: document.getElementById('dash_result').checked
            };
            
            saveData();
            applyDashboardSettings();
        }

        function applyDashboardSettings() {
            if (!data.dashboardSettings) return;
            
            // Show/hide cards based on settings
            document.querySelectorAll('[data-card]').forEach(card => {
                const cardName = card.dataset.card;
                if (data.dashboardSettings.hasOwnProperty(cardName)) {
                    card.style.display = data.dashboardSettings[cardName] ? '' : 'none';
                }
            });
            
            // Handle result box
            const resultBox = document.getElementById('dashboardResult');
            if (resultBox) {
                resultBox.style.display = data.dashboardSettings.result ? '' : 'none';
            }
        }

        // ========== DATA ==========
        // Default empty year data structure
        function createEmptyYearData(year) {
            // Default tax brackets for 2025
            const defaultBrackets = [
                { min: 0, max: 84120, rate: 10 },
                { min: 84120, max: 120720, rate: 14 },
                { min: 120720, max: 193800, rate: 20 },
                { min: 193800, max: 269280, rate: 31 },
                { min: 269280, max: 560280, rate: 35 },
                { min: 560280, max: 721560, rate: 47 },
                { min: 721560, max: 999999999, rate: 50 }
            ];
            
            // Default BL brackets for 2025 (ANNUAL values = monthly Ã— 12)
            // Based on BTL website: https://www.btl.gov.il/Insurance/National%20Insurance/type_list/Self_Employed/Pages/rates.aspx
            // Monthly values: 7,522 and 50,695 â†’ Annual: 90,264 and 608,340
            const defaultBLBrackets = [
                { 
                    min: 0, 
                    max: 90264,  // 7,522 Ã— 12 (60% of average salary, annual)
                    blRate: 4.47,
                    healthRate: 3.23,
                    totalRate: 7.70,
                    label: '×©×™×¢×•×¨ ××•×¤×—×ª (×¢×“ 60% ××”×©×›×¨ ×”×××•×¦×¢)'
                },
                { 
                    min: 90264, 
                    max: 608340,  // 50,695 Ã— 12 (maximum insurable income, annual)
                    blRate: 12.83,
                    healthRate: 5.17,
                    totalRate: 18,
                    label: '×©×™×¢×•×¨ ××œ× (××¢×œ 60% ×•×¢×“ ×”×ª×§×¨×”)'
                }
            ];
            
            return {
                salary: [],
                unemployment: [],
                miluim: [],
                selfEmployed: [],
                expenses: [],
                taxAdvances: [],
                blAdvances: [],
                vatReports: [],
                businessStatus: 'zair',
                credits: {
                    woman: false,
                    divorcedAlimony: false,
                    singleParent: false,
                    army: false,
                    degree: false,
                    degree2: false,
                    oleh: false,
                    childrenYoung: 0,
                    childrenOld: 0
                },
                settings: {
                    taxBrackets: defaultBrackets,
                    blBrackets: defaultBLBrackets,
                    creditValue: 242,
                    vatRate: 17
                }
            };
        }

        let data = {
            years: [2025, 2024],
            dashboardSettings: {
                salary: true,
                unemployment: true,
                miluim: true,
                selfemployed: true,
                totalIncome: true,
                credits: true,
                taxDue: true,
                taxPaid: true,
                blDue: true,
                blPaid: true,
                paymentsSummary: true,
                result: true
            },
            yearData: {}
        };

        // Helper to get current year's data
        function getYearData() {
            if (!data.yearData[currentYear]) {
                data.yearData[currentYear] = createEmptyYearData(currentYear);
            }
            return data.yearData[currentYear];
        }

        let currentYear = new Date().getFullYear();
        const MONTHS = ['', '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];

        // ========== INIT ==========
        async function init() {
            const hasLocalData = loadData();
            
            // If no local data, try to restore from Google Drive
            if (!hasLocalData) {
                await tryAutoRestoreFromDrive();
            }
            
            renderYearSelector();
            loadDashboardSettings();
            loadBusinessStatus();
            loadFavorites();
            renderAll();
            checkLastBackup();
            initLocalFolder();
        }
        
        // Try to auto-restore from Google Drive
        async function tryAutoRestoreFromDrive() {
            // New GIS API doesn't support silent auth
            // User needs to click "Connect to Google" button
            console.log('Auto-restore from Drive: User needs to connect manually');
        }

        function loadData() {
            const saved = localStorage.getItem('taxCalculatorV2');
            if (saved) {
                const loadedData = JSON.parse(saved);
                
                // Check if we need to migrate to new year-based structure
                if (!loadedData.yearData) {
                    // Migrate old flat structure to year-based
                    console.log('Migrating to year-based data structure...');
                    
                    const oldYearData = {
                        salary: loadedData.salary || [],
                        unemployment: loadedData.unemployment || [],
                        miluim: loadedData.miluim || [],
                        selfEmployed: loadedData.selfEmployed || [],
                        expenses: loadedData.expenses || [],
                        taxAdvances: loadedData.taxAdvances || [],
                        blAdvances: loadedData.blAdvances || [],
                        vatReports: loadedData.vatReports || [],
                        businessStatus: loadedData.businessStatus || 'zair',
                        credits: loadedData.credits || createEmptyYearData().credits,
                        settings: loadedData.settings || createEmptyYearData().settings
                    };
                    
                    // Handle old advancePayments migration
                    if (loadedData.advancePayments && loadedData.advancePayments.length > 0) {
                        loadedData.advancePayments.forEach(p => {
                            if (p.tax > 0) {
                                oldYearData.taxAdvances.push({
                                    id: p.id,
                                    month: p.month,
                                    amount: p.tax,
                                    notes: p.notes || ''
                                });
                            }
                            if (p.bl > 0) {
                                oldYearData.blAdvances.push({
                                    id: p.id + 1,
                                    month: p.month,
                                    amount: p.bl,
                                    notes: p.notes || ''
                                });
                            }
                        });
                    }
                    
                    // Put old data under current year
                    data.yearData = {};
                    data.yearData[currentYear] = oldYearData;
                    
                    // Copy shared settings (dashboard only)
                    if (loadedData.years) data.years = loadedData.years;
                    if (loadedData.dashboardSettings) data.dashboardSettings = loadedData.dashboardSettings;
                    
                    saveData();
                    console.log('Migration complete!');
                } else {
                    // Already in new format - just load
                    data = {...data, ...loadedData};
                    
                    // Migration: move old shared settings to year data if needed
                    if (loadedData.settings && !loadedData.yearData[currentYear]?.settings) {
                        Object.keys(data.yearData).forEach(year => {
                            if (!data.yearData[year].settings) {
                                data.yearData[year].settings = loadedData.settings;
                            }
                            if (!data.yearData[year].businessStatus) {
                                data.yearData[year].businessStatus = loadedData.businessStatus || 'zair';
                            }
                        });
                        saveData();
                    }
                }
                
                // Ensure yearData exists for current year
                if (!data.yearData) data.yearData = {};
                if (!data.yearData[currentYear]) {
                    data.yearData[currentYear] = createEmptyYearData(currentYear);
                }
                // Ensure settings exist for current year
                if (!data.yearData[currentYear].settings) {
                    data.yearData[currentYear].settings = createEmptyYearData(currentYear).settings;
                }
                if (!data.yearData[currentYear].businessStatus) {
                    data.yearData[currentYear].businessStatus = 'zair';
                }
                
                // Migration: convert old BL settings to new blBrackets format
                Object.keys(data.yearData).forEach(year => {
                    const yd = data.yearData[year];
                    if (yd.settings && !yd.settings.blBrackets) {
                        // Old format detected - migrate to new format
                        const oldCeiling = yd.settings.blCeiling || 90264;
                        const oldReducedRate = yd.settings.blReducedRate || 6.92;
                        const oldFullRate = yd.settings.blFullRate || 18;
                        
                        yd.settings.blBrackets = [
                            { 
                                min: 0, 
                                max: oldCeiling,
                                blRate: 4.47,
                                healthRate: 3.23,
                                totalRate: oldReducedRate,
                                label: '×©×™×¢×•×¨ ××•×¤×—×ª (×¢×“ 60% ××”×©×›×¨ ×”×××•×¦×¢)'
                            },
                            { 
                                min: oldCeiling, 
                                max: 608340,
                                blRate: 12.83,
                                healthRate: 5.17,
                                totalRate: oldFullRate,
                                label: '×©×™×¢×•×¨ ××œ× (××¢×œ 60% ×•×¢×“ ×”×ª×§×¨×”)'
                            }
                        ];
                        
                        // Remove old fields
                        delete yd.settings.blReducedRate;
                        delete yd.settings.blFullRate;
                        delete yd.settings.blCeiling;
                        
                        console.log('Migrated BL settings to brackets format for year ' + year);
                    }
                });
                saveData();
                loadCreditsToUI();
                return true; // Data was found
            }
            
            // No saved data - initialize empty
            data = { years: [currentYear], yearData: {} };
            data.yearData[currentYear] = createEmptyYearData(currentYear);
            return false; // No data found
        }

        function loadCreditsToUI() {
            const yearData = getYearData();
            document.getElementById('credit_woman').checked = yearData.credits.woman;
            document.getElementById('credit_divorced_alimony').checked = yearData.credits.divorcedAlimony;
            document.getElementById('credit_single_parent').checked = yearData.credits.singleParent;
            document.getElementById('credit_army').checked = yearData.credits.army;
            document.getElementById('credit_degree').checked = yearData.credits.degree;
            document.getElementById('credit_degree2').checked = yearData.credits.degree2;
            document.getElementById('credit_oleh').checked = yearData.credits.oleh;
            document.getElementById('children_young').value = yearData.credits.childrenYoung;
            document.getElementById('children_old').value = yearData.credits.childrenOld;
        }

        function saveData() {
            localStorage.setItem('taxCalculatorV2', JSON.stringify(data));
            // Also save to local folder and Drive if available
            saveDataToLocalFolder();
            saveDataToDrive();
        }
        
        // Save data.json to local folder
        async function saveDataToLocalFolder() {
            if (!localFolderHandle) return;
            
            try {
                const permission = await localFolderHandle.queryPermission({ mode: 'readwrite' });
                if (permission !== 'granted') return;
                
                // Get or create john-finance folder
                const rootFolder = await localFolderHandle.getDirectoryHandle('john-finance', { create: true });
                
                // Save data.json
                const fileHandle = await rootFolder.getFileHandle('data.json', { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(data, null, 2));
                await writable.close();
                
                console.log('Data saved to local folder');
            } catch (e) {
                console.error('Error saving to local folder:', e);
            }
        }
        
        // Save data.json to Google Drive (debounced)
        let driveeSaveTimeout = null;
        async function saveDataToDrive() {
            if (!googleAccessToken || !driveFolderId) return;
            
            // Debounce - wait 3 seconds before saving to avoid too many API calls
            if (driveeSaveTimeout) clearTimeout(driveeSaveTimeout);
            driveeSaveTimeout = setTimeout(async () => {
                try {
                    // Check if data.json already exists
                    const search = await gapi.client.drive.files.list({
                        q: `name='data.json' and '${driveFolderId}' in parents and trashed=false`,
                        fields: 'files(id)'
                    });
                    
                    const jsonContent = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonContent], { type: 'application/json' });
                    
                    if (search.result.files.length > 0) {
                        // Update existing file
                        const fileId = search.result.files[0].id;
                        await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': 'Bearer ' + googleAccessToken,
                                'Content-Type': 'application/json'
                            },
                            body: jsonContent
                        });
                    } else {
                        // Create new file
                        const metadata = {
                            name: 'data.json',
                            parents: [driveFolderId]
                        };
                        
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        form.append('file', blob);
                        
                        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + googleAccessToken
                            },
                            body: form
                        });
                    }
                    
                    console.log('Data saved to Google Drive');
                } catch (e) {
                    console.error('Error saving to Drive:', e);
                }
            }, 3000);
        }
        
        // Load data from local folder
        async function loadDataFromLocalFolder() {
            if (!localFolderHandle) return null;
            
            try {
                const permission = await localFolderHandle.requestPermission({ mode: 'readwrite' });
                if (permission !== 'granted') return null;
                
                const rootFolder = await localFolderHandle.getDirectoryHandle('john-finance', { create: false });
                const fileHandle = await rootFolder.getFileHandle('data.json', { create: false });
                const file = await fileHandle.getFile();
                const text = await file.text();
                return JSON.parse(text);
            } catch (e) {
                console.log('No local data.json found or error reading:', e.message);
                return null;
            }
        }
        
        // Try to restore data from local folder on startup
        async function tryRestoreFromLocal() {
            if (!localFolderHandle) return;
            
            const localData = await loadDataFromLocalFolder();
            if (localData) {
                // Check if local data is newer or localStorage is empty
                const localStorageData = localStorage.getItem('taxCalculatorV2');
                if (!localStorageData) {
                    // localStorage is empty, restore from local
                    data = localData;
                    saveData();
                    renderAll();
                    console.log('Data restored from local folder');
                }
            }
        }

        // ========== NAVIGATION ==========
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function changeYear() {
            const selectedYear = parseInt(document.getElementById('currentYear').value);
            if (selectedYear && !isNaN(selectedYear)) {
                currentYear = selectedYear;
                // Ensure year data exists
                if (!data.yearData[currentYear]) {
                    data.yearData[currentYear] = createEmptyYearData(currentYear);
                }
                loadCreditsToUI();
                loadBusinessStatus();
                renderAll();
            }
        }

        function openModal(id) { 
            document.getElementById(id).classList.add('active');
            if (id === 'yearModal') {
                renderYearsList();
            }
        }
        function closeModal(id) { 
            document.getElementById(id).classList.remove('active');
            editingId = null;
            clearForm(id);
        }
        
        function clearForm(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]').forEach(input => {
                input.value = '';
            });
            modal.querySelectorAll('input[type="file"]').forEach(input => {
                input.value = '';
            });
            modal.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            // Clear file status spans
            modal.querySelectorAll('[id$="FileStatus"]').forEach(span => {
                span.textContent = '';
            });
        }

        // ========== CRUD OPERATIONS ==========
        async function addSalary() {
            const yd = getYearData();
            const recordId = editingId || Date.now();
            
            const itemData = {
                employer: document.getElementById('salaryEmployer').value,
                fromMonth: parseInt(document.getElementById('salaryFromMonth').value),
                toMonth: parseInt(document.getElementById('salaryToMonth').value),
                gross: parseFloat(document.getElementById('salaryGross').value) || 0,
                taxDeducted: parseFloat(document.getElementById('salaryTaxDeducted').value) || 0,
                blDeducted: parseFloat(document.getElementById('salaryBLDeducted').value) || 0,
                notes: document.getElementById('salaryNotes').value
            };
            
            // Handle file upload
            const fileInput = document.getElementById('salaryFile');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                document.getElementById('salaryFileStatus').textContent = 'â³ ××¢×œ×”...';
                
                const results = await uploadDocument(file, '×©×›×™×¨', 'salary', recordId);
                
                if (results.local || results.drive) {
                    itemData.fileName = file.name;
                    itemData.localPath = results.local;
                    itemData.driveId = results.drive?.id;
                    itemData.driveLink = results.drive?.link;
                    document.getElementById('salaryFileStatus').textContent = 'âœ… ×”×•×¢×œ×”!';
                } else {
                    document.getElementById('salaryFileStatus').textContent = 'âš ï¸ ×œ× ×”×•×¢×œ×”';
                }
            }
            
            if (editingId) {
                const idx = yd.salary.findIndex(s => s.id === editingId);
                if (idx !== -1) {
                    yd.salary[idx] = { ...yd.salary[idx], ...itemData };
                }
                editingId = null;
            } else {
                yd.salary.push({ id: recordId, ...itemData });
            }
            
            saveData();
            closeModal('salaryModal');
            clearForm('salaryModal');
            renderAll();
        }

        async function addUnemployment() {
            const yd = getYearData();
            const recordId = editingId || Date.now();
            
            const itemData = {
                fromMonth: parseInt(document.getElementById('unemploymentFromMonth').value),
                toMonth: parseInt(document.getElementById('unemploymentToMonth').value),
                gross: parseFloat(document.getElementById('unemploymentGross').value) || 0,
                taxDeducted: parseFloat(document.getElementById('unemploymentTaxDeducted').value) || 0,
                blDeducted: parseFloat(document.getElementById('unemploymentBLDeducted').value) || 0,
                notes: document.getElementById('unemploymentNotes').value
            };
            
            // Handle file upload
            const fileInput = document.getElementById('unemploymentFile');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                document.getElementById('unemploymentFileStatus').textContent = 'â³ ××¢×œ×”...';
                
                const results = await uploadDocument(file, '××‘×˜×œ×”', 'unemployment', recordId);
                
                if (results.local || results.drive) {
                    itemData.fileName = file.name;
                    itemData.localPath = results.local;
                    itemData.driveId = results.drive?.id;
                    itemData.driveLink = results.drive?.link;
                    document.getElementById('unemploymentFileStatus').textContent = 'âœ… ×”×•×¢×œ×”!';
                } else {
                    document.getElementById('unemploymentFileStatus').textContent = 'âš ï¸ ×œ× ×”×•×¢×œ×”';
                }
            }
            
            if (editingId) {
                const idx = yd.unemployment.findIndex(u => u.id === editingId);
                if (idx !== -1) {
                    yd.unemployment[idx] = { ...yd.unemployment[idx], ...itemData };
                }
                editingId = null;
            } else {
                yd.unemployment.push({ id: recordId, ...itemData });
            }
            
            saveData();
            closeModal('unemploymentModal');
            clearForm('unemploymentModal');
            renderAll();
        }

        async function addMiluim() {
            const yd = getYearData();
            const recordId = editingId || Date.now();
            
            const itemData = {
                from: document.getElementById('miluimFrom').value,
                to: document.getElementById('miluimTo').value,
                days: parseInt(document.getElementById('miluimDays').value) || 0,
                amount: parseFloat(document.getElementById('miluimAmount').value) || 0,
                taxDeducted: parseFloat(document.getElementById('miluimTaxDeducted').value) || 0,
                blDeducted: parseFloat(document.getElementById('miluimBLDeducted').value) || 0,
                notes: document.getElementById('miluimNotes').value
            };
            
            // Handle file upload
            const fileInput = document.getElementById('miluimFile');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                document.getElementById('miluimFileStatus').textContent = 'â³ ××¢×œ×”...';
                
                const results = await uploadDocument(file, '××™×œ×•××™×', 'miluim', recordId);
                
                if (results.local || results.drive) {
                    itemData.fileName = file.name;
                    itemData.localPath = results.local;
                    itemData.driveId = results.drive?.id;
                    itemData.driveLink = results.drive?.link;
                    document.getElementById('miluimFileStatus').textContent = 'âœ… ×”×•×¢×œ×”!';
                } else {
                    document.getElementById('miluimFileStatus').textContent = 'âš ï¸ ×œ× ×”×•×¢×œ×”';
                }
            }
            
            if (editingId) {
                const idx = yd.miluim.findIndex(m => m.id === editingId);
                if (idx !== -1) {
                    yd.miluim[idx] = { ...yd.miluim[idx], ...itemData };
                }
                editingId = null;
            } else {
                yd.miluim.push({ id: recordId, ...itemData });
            }
            
            saveData();
            closeModal('miluimModal');
            clearForm('miluimModal');
            renderAll();
        }

        async function addSelfEmployed() {
            const yd = getYearData();
            const recordId = editingId || Date.now();
            
            const itemData = {
                month: parseInt(document.getElementById('selfMonth').value),
                description: document.getElementById('selfDescription').value,
                amount: parseFloat(document.getElementById('selfAmount').value) || 0,
                notes: document.getElementById('selfNotes').value
            };
            
            // Handle file upload
            const fileInput = document.getElementById('selfFile');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                document.getElementById('selfFileStatus').textContent = 'â³ ××¢×œ×”...';
                
                const results = await uploadDocument(file, '×—×©×‘×•× ×™×•×ª-×¢×¦×××™', 'selfEmployed', recordId);
                
                if (results.local || results.drive) {
                    itemData.fileName = file.name;
                    itemData.localPath = results.local;
                    itemData.driveId = results.drive?.id;
                    itemData.driveLink = results.drive?.link;
                    document.getElementById('selfFileStatus').textContent = 'âœ… ×”×•×¢×œ×”!';
                } else {
                    document.getElementById('selfFileStatus').textContent = 'âš ï¸ ×œ× ×”×•×¢×œ×”';
                }
            }
            
            if (editingId) {
                const idx = yd.selfEmployed.findIndex(s => s.id === editingId);
                if (idx !== -1) {
                    yd.selfEmployed[idx] = { ...yd.selfEmployed[idx], ...itemData };
                }
                editingId = null;
            } else {
                yd.selfEmployed.push({ id: recordId, ...itemData });
            }
            
            saveData();
            closeModal('selfEmployedModal');
            clearForm('selfEmployedModal');
            renderAll();
        }

        async function addExpense() {
            const yd = getYearData();
            const recordId = editingId || Date.now();
            
            const itemData = {
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDesc').value,
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value) || 0,
                notes: document.getElementById('expenseNotes').value
            };
            
            // Handle file upload
            const fileInput = document.getElementById('expenseFile');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                document.getElementById('expenseFileStatus').textContent = 'â³ ××¢×œ×”...';
                
                const results = await uploadDocument(file, '×”×•×¦××•×ª-××•×›×¨×•×ª', 'expense', recordId);
                
                if (results.local || results.drive) {
                    itemData.fileName = file.name;
                    itemData.localPath = results.local;
                    itemData.driveId = results.drive?.id;
                    itemData.driveLink = results.drive?.link;
                    document.getElementById('expenseFileStatus').textContent = 'âœ… ×”×•×¢×œ×”!';
                } else {
                    document.getElementById('expenseFileStatus').textContent = 'âš ï¸ ×œ× ×”×•×¢×œ×”';
                }
            }
            
            if (editingId) {
                const idx = yd.expenses.findIndex(e => e.id === editingId);
                if (idx !== -1) {
                    yd.expenses[idx] = { ...yd.expenses[idx], ...itemData };
                }
                editingId = null;
            } else {
                yd.expenses.push({ id: recordId, ...itemData });
            }
            
            saveData();
            closeModal('expenseModal');
            clearForm('expenseModal');
            renderAll();
        }

        async function addTaxAdvance() {
            const yd = getYearData();
            const recordId = editingId || Date.now();
            
            const itemData = {
                month: parseInt(document.getElementById('taxAdvanceMonth').value),
                amount: parseFloat(document.getElementById('taxAdvanceAmount').value) || 0,
                notes: document.getElementById('taxAdvanceNotes').value
            };
            
            // Handle file upload
            const fileInput = document.getElementById('taxAdvanceFile');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                document.getElementById('taxAdvanceFileStatus').textContent = 'â³ ××¢×œ×”...';
                
                const results = await uploadDocument(file, '××§×“××•×ª-××¡', 'taxAdvance', recordId);
                
                if (results.local || results.drive) {
                    itemData.fileName = file.name;
                    itemData.localPath = results.local;
                    itemData.driveId = results.drive?.id;
                    itemData.driveLink = results.drive?.link;
                    document.getElementById('taxAdvanceFileStatus').textContent = 'âœ… ×”×•×¢×œ×”!';
                } else {
                    document.getElementById('taxAdvanceFileStatus').textContent = 'âš ï¸ ×œ× ×”×•×¢×œ×”';
                }
            }
            
            if (editingId) {
                const idx = yd.taxAdvances.findIndex(p => p.id === editingId);
                if (idx !== -1) {
                    yd.taxAdvances[idx] = { ...yd.taxAdvances[idx], ...itemData };
                }
                editingId = null;
            } else {
                yd.taxAdvances.push({ id: recordId, ...itemData });
            }
            
            yd.taxAdvances.sort((a, b) => a.month - b.month);
            saveData();
            closeModal('taxAdvanceModal');
            clearForm('taxAdvanceModal');
            renderAll();
        }

        function editTaxAdvance(id) {
            const yd = getYearData();
            const item = yd.taxAdvances.find(p => p.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('taxAdvanceMonth').value = item.month;
            document.getElementById('taxAdvanceAmount').value = item.amount;
            document.getElementById('taxAdvanceNotes').value = item.notes || '';
            openModal('taxAdvanceModal');
        }

        function deleteTaxAdvance(id) {
            const yd = getYearData();
            if (confirm('×œ××—×•×§?')) {
                yd.taxAdvances = yd.taxAdvances.filter(p => p.id !== id);
                saveData();
                renderAll();
            }
        }

        async function addBLAdvance() {
            const yd = getYearData();
            const recordId = editingId || Date.now();
            
            const itemData = {
                month: parseInt(document.getElementById('blAdvanceMonth').value),
                amount: parseFloat(document.getElementById('blAdvanceAmount').value) || 0,
                notes: document.getElementById('blAdvanceNotes').value
            };
            
            // Handle file upload
            const fileInput = document.getElementById('blAdvanceFile');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                document.getElementById('blAdvanceFileStatus').textContent = 'â³ ××¢×œ×”...';
                
                const results = await uploadDocument(file, '×‘×™×˜×•×—-×œ××•××™', 'blAdvance', recordId);
                
                if (results.local || results.drive) {
                    itemData.fileName = file.name;
                    itemData.localPath = results.local;
                    itemData.driveId = results.drive?.id;
                    itemData.driveLink = results.drive?.link;
                    document.getElementById('blAdvanceFileStatus').textContent = 'âœ… ×”×•×¢×œ×”!';
                } else {
                    document.getElementById('blAdvanceFileStatus').textContent = 'âš ï¸ ×œ× ×”×•×¢×œ×”';
                }
            }
            
            if (editingId) {
                const idx = yd.blAdvances.findIndex(p => p.id === editingId);
                if (idx !== -1) {
                    yd.blAdvances[idx] = { ...yd.blAdvances[idx], ...itemData };
                }
                editingId = null;
            } else {
                yd.blAdvances.push({ id: recordId, ...itemData });
            }
            
            yd.blAdvances.sort((a, b) => a.month - b.month);
            saveData();
            closeModal('blAdvanceModal');
            clearForm('blAdvanceModal');
            renderAll();
        }

        function editBLAdvance(id) {
            const yd = getYearData();
            const item = yd.blAdvances.find(p => p.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('blAdvanceMonth').value = item.month;
            document.getElementById('blAdvanceAmount').value = item.amount;
            document.getElementById('blAdvanceNotes').value = item.notes || '';
            openModal('blAdvanceModal');
        }

        function deleteBLAdvance(id) {
            const yd = getYearData();
            if (confirm('×œ××—×•×§?')) {
                yd.blAdvances = yd.blAdvances.filter(p => p.id !== id);
                saveData();
                renderAll();
            }
        }

        // ========== BUSINESS STATUS & VAT ==========
        function updateBusinessStatus() {
            const yd = getYearData();
            const status = document.getElementById('businessStatus').value;
            yd.businessStatus = status;
            
            // Show/hide VAT section
            const vatInfo = document.getElementById('vatInfo');
            const navVat = document.getElementById('navVat');
            
            if (status === 'murshe') {
                vatInfo.style.display = 'block';
                navVat.style.display = 'flex';
            } else {
                vatInfo.style.display = 'none';
                navVat.style.display = 'none';
            }
            
            saveData();
            renderAll();
        }

        function loadBusinessStatus() {
            const yd = getYearData();
            const status = yd.businessStatus || 'zair';
            const select = document.getElementById('businessStatus');
            if (select) select.value = status;
            
            const vatInfo = document.getElementById('vatInfo');
            const navVat = document.getElementById('navVat');
            
            if (status === 'murshe') {
                if (vatInfo) vatInfo.style.display = 'block';
                if (navVat) navVat.style.display = 'flex';
            } else {
                if (vatInfo) vatInfo.style.display = 'none';
                if (navVat) navVat.style.display = 'none';
            }
        }

        function addVatReport() {
            const yd = getYearData();
            const itemData = {
                period: document.getElementById('vatPeriod').value,
                income: parseFloat(document.getElementById('vatIncomeAmount').value) || 0,
                outputVat: parseFloat(document.getElementById('vatOutputAmount').value) || 0,
                expenses: parseFloat(document.getElementById('vatExpenseAmount').value) || 0,
                inputVat: parseFloat(document.getElementById('vatInputAmount').value) || 0,
                notes: document.getElementById('vatNotes').value
            };
            
            if (editingId) {
                const idx = yd.vatReports.findIndex(v => v.id === editingId);
                if (idx !== -1) {
                    yd.vatReports[idx] = { ...yd.vatReports[idx], ...itemData };
                }
                editingId = null;
            } else {
                yd.vatReports.push({ id: Date.now(), ...itemData });
            }
            
            saveData();
            closeModal('vatModal');
            clearForm('vatModal');
            renderAll();
        }

        function editVatReport(id) {
            const yd = getYearData();
            const item = yd.vatReports.find(v => v.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('vatPeriod').value = item.period;
            document.getElementById('vatIncomeAmount').value = item.income;
            document.getElementById('vatOutputAmount').value = item.outputVat;
            document.getElementById('vatExpenseAmount').value = item.expenses;
            document.getElementById('vatInputAmount').value = item.inputVat;
            document.getElementById('vatNotes').value = item.notes || '';
            openModal('vatModal');
        }

        function deleteVatReport(id) {
            const yd = getYearData();
            if (confirm('×œ××—×•×§?')) {
                yd.vatReports = yd.vatReports.filter(v => v.id !== id);
                saveData();
                renderAll();
            }
        }

        function renderVatTable() {
            const yd = getYearData();
            const tbody = document.getElementById('vatTable');
            if (!tbody) return;
            
            if (!yd.vatReports || yd.vatReports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="icon">ğŸ“Š</div><p>×œ×—×¥ + ×œ×”×•×¡×™×£ ×“×™×•×•×— ××¢"×</p></td></tr>';
                document.getElementById('vatTotalRefund').textContent = 'â‚ª0';
                document.getElementById('vatIncome').textContent = 'â‚ª0';
                document.getElementById('vatExpenses').textContent = 'â‚ª0';
                document.getElementById('vatOnExpenses').textContent = 'â‚ª0';
                return;
            }
            
            const PERIOD_NAMES = {
                '1-2': '×™× ×•-×¤×‘×¨',
                '3-4': '××¨×¥-××¤×¨',
                '5-6': '×××™-×™×•× ',
                '7-8': '×™×•×œ-××•×’',
                '9-10': '×¡×¤×˜-××•×§',
                '11-12': '× ×•×‘-×“×¦×'
            };
            
            let totalIncome = 0;
            let totalExpenses = 0;
            let totalInputVat = 0;
            let totalOutputVat = 0;
            
            tbody.innerHTML = yd.vatReports.map(v => {
                totalIncome += v.income;
                totalExpenses += v.expenses;
                totalInputVat += v.inputVat;
                totalOutputVat += v.outputVat;
                const diff = v.outputVat - v.inputVat;
                
                return `<tr>
                    <td>${PERIOD_NAMES[v.period] || v.period} ${v.notes ? '<span title="'+v.notes+'" style="cursor:help;">ğŸ“</span>' : ''}</td>
                    <td>${formatCurrency(v.income)}</td>
                    <td>${formatCurrency(v.outputVat)}</td>
                    <td style="color:var(--success)">${formatCurrency(v.inputVat)}</td>
                    <td style="color:${diff < 0 ? 'var(--success)' : 'var(--danger)'}">${diff < 0 ? '×”×—×–×¨ ' : '×œ×©×œ× '}${formatCurrency(Math.abs(diff))}</td>
                    <td>
                        <button class="btn btn-icon btn-sm" onclick="editVatReport(${v.id})" title="×¢×¨×™×›×”">âœï¸</button>
                        <button class="btn btn-icon btn-sm" onclick="deleteVatReport(${v.id})" title="××—×™×§×”">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
            }).join('');
            
            // Summary
            const totalRefund = totalInputVat - totalOutputVat;
            document.getElementById('vatIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('vatExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('vatOnExpenses').textContent = formatCurrency(totalInputVat);
            document.getElementById('vatTotalRefund').textContent = formatCurrency(Math.max(0, totalRefund));
            
            const resultBox = document.getElementById('vatResultBox');
            if (totalRefund > 0) {
                resultBox.className = 'result-box refund';
                resultBox.querySelector('div:first-child').textContent = 'ğŸ’° ×¡×”"×› ××¢"× ×œ×§×™×–×•×– (×”×—×–×¨ ×¦×¤×•×™)';
            } else if (totalRefund < 0) {
                resultBox.className = 'result-box owe';
                resultBox.querySelector('div:first-child').textContent = 'ğŸ’³ ×¡×”"×› ××¢"× ×œ×ª×©×œ×•×';
                document.getElementById('vatTotalRefund').textContent = formatCurrency(Math.abs(totalRefund));
            }
        }

        function deleteItem(type, id) {
            const yd = getYearData();
            if (confirm('×œ××—×•×§?')) {
                yd[type] = yd[type].filter(i => i.id !== id);
                saveData();
                renderAll();
            }
        }

        // ========== EDIT FUNCTIONS ==========
        let editingId = null;

        function editSalary(id) {
            const yd = getYearData();
            const item = yd.salary.find(s => s.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('salaryEmployer').value = item.employer || '';
            document.getElementById('salaryFromMonth').value = item.fromMonth;
            document.getElementById('salaryToMonth').value = item.toMonth;
            document.getElementById('salaryGross').value = item.gross;
            document.getElementById('salaryTaxDeducted').value = item.taxDeducted;
            document.getElementById('salaryBLDeducted').value = item.blDeducted;
            document.getElementById('salaryNotes').value = item.notes || '';
            openModal('salaryModal');
        }

        function editUnemployment(id) {
            const yd = getYearData();
            const item = yd.unemployment.find(u => u.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('unemploymentFromMonth').value = item.fromMonth;
            document.getElementById('unemploymentToMonth').value = item.toMonth;
            document.getElementById('unemploymentGross').value = item.gross;
            document.getElementById('unemploymentTaxDeducted').value = item.taxDeducted;
            document.getElementById('unemploymentBLDeducted').value = item.blDeducted || 0;
            document.getElementById('unemploymentNotes').value = item.notes || '';
            openModal('unemploymentModal');
        }

        function editMiluim(id) {
            const yd = getYearData();
            const item = yd.miluim.find(m => m.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('miluimFrom').value = item.from;
            document.getElementById('miluimTo').value = item.to;
            document.getElementById('miluimDays').value = item.days;
            document.getElementById('miluimAmount').value = item.amount;
            document.getElementById('miluimTaxDeducted').value = item.taxDeducted || 0;
            document.getElementById('miluimBLDeducted').value = item.blDeducted || 0;
            document.getElementById('miluimNotes').value = item.notes || '';
            openModal('miluimModal');
        }

        function editSelfEmployed(id) {
            const yd = getYearData();
            const item = yd.selfEmployed.find(s => s.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('selfMonth').value = item.month;
            document.getElementById('selfDescription').value = item.description || '';
            document.getElementById('selfAmount').value = item.amount;
            document.getElementById('selfNotes').value = item.notes || '';
            openModal('selfEmployedModal');
        }

        function editExpense(id) {
            const yd = getYearData();
            const item = yd.expenses.find(e => e.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('expenseDate').value = item.date;
            document.getElementById('expenseDesc').value = item.description || '';
            document.getElementById('expenseCategory').value = item.category;
            document.getElementById('expenseAmount').value = item.amount;
            document.getElementById('expenseNotes').value = item.notes || '';
            openModal('expenseModal');
        }

        // ========== CREDITS ==========
        function updateCredits() {
            const yd = getYearData();
            yd.credits = {
                woman: document.getElementById('credit_woman').checked,
                divorcedAlimony: document.getElementById('credit_divorced_alimony').checked,
                singleParent: document.getElementById('credit_single_parent').checked,
                army: document.getElementById('credit_army').checked,
                degree: document.getElementById('credit_degree').checked,
                degree2: document.getElementById('credit_degree2').checked,
                oleh: document.getElementById('credit_oleh').checked,
                childrenYoung: parseInt(document.getElementById('children_young').value) || 0,
                childrenOld: parseInt(document.getElementById('children_old').value) || 0
            };
            saveData();
            renderAll();
        }

        function calculateCredits() {
            const yd = getYearData();
            let points = 2.25; // Base for Israeli resident
            if (yd.credits.woman) points += 0.5;
            if (yd.credits.divorcedAlimony) points += 1;
            if (yd.credits.singleParent) points += 1;
            if (yd.credits.army) points += 2;
            if (yd.credits.degree) points += 1;
            if (yd.credits.degree2) points += 0.5;
            if (yd.credits.oleh) points += 2.25;
            points += yd.credits.childrenYoung * 2.5;
            points += yd.credits.childrenOld * 1;
            
            return points;
        }

        // ========== TAX CALCULATIONS ==========
        function calculateTotals() {
            const yd = getYearData();
            const totalSalary = yd.salary.reduce((sum, s) => sum + s.gross, 0);
            const totalUnemployment = yd.unemployment.reduce((sum, u) => sum + u.gross, 0);
            const totalMiluim = yd.miluim.reduce((sum, m) => sum + m.amount, 0);
            const totalMiluimDays = yd.miluim.reduce((sum, m) => sum + m.days, 0);
            const totalSelfEmployed = yd.selfEmployed.reduce((sum, s) => sum + s.amount, 0);
            const totalExpenses = yd.expenses.reduce((sum, e) => sum + e.amount, 0);
            
            // Tax deducted from each source
            const taxFromSalary = yd.salary.reduce((sum, s) => sum + s.taxDeducted, 0);
            const taxFromUnemployment = yd.unemployment.reduce((sum, u) => sum + u.taxDeducted, 0);
            const taxFromMiluim = yd.miluim.reduce((sum, m) => sum + (m.taxDeducted || 0), 0);
            
            // BL deducted from each source
            const blFromSalary = yd.salary.reduce((sum, s) => sum + (s.blDeducted || 0), 0);
            const blFromUnemployment = yd.unemployment.reduce((sum, u) => sum + (u.blDeducted || 0), 0);
            const blFromMiluim = yd.miluim.reduce((sum, m) => sum + (m.blDeducted || 0), 0);
            
            // Calculate from separate advance payment arrays
            const taxFromSelf = yd.taxAdvances.reduce((sum, p) => sum + p.amount, 0);
            const blFromSelf = yd.blAdvances.reduce((sum, p) => sum + p.amount, 0);
            
            // Total BL paid from all sources
            const totalBLPaid = blFromSalary + blFromUnemployment + blFromMiluim + blFromSelf;
            
            // Taxable income (miluim IS taxable - not exempt!)
            const taxableIncome = totalSalary + totalUnemployment + totalMiluim + Math.max(0, totalSelfEmployed - totalExpenses);
            
            // Self employed net income for BL calculation
            const selfEmployedNet = Math.max(0, totalSelfEmployed - totalExpenses);
            
            return {
                salary: totalSalary,
                unemployment: totalUnemployment,
                miluim: totalMiluim,
                miluimDays: totalMiluimDays,
                selfEmployed: totalSelfEmployed,
                expenses: totalExpenses,
                selfEmployedNet,
                taxableIncome,
                taxFromSalary,
                taxFromUnemployment,
                taxFromMiluim,
                taxFromSelf,
                blFromSalary,
                blFromUnemployment,
                blFromMiluim,
                blFromSelf,
                totalBLPaid,
                totalTaxPaid: taxFromSalary + taxFromUnemployment + taxFromMiluim + taxFromSelf
            };
        }

        function calculateIncomeTax(income) {
            const yd = getYearData();
            let tax = 0;
            const details = [];
            
            for (const bracket of yd.settings.taxBrackets) {
                if (income <= bracket.min) break;
                const inBracket = Math.min(income, bracket.max) - bracket.min;
                const taxInBracket = inBracket * (bracket.rate / 100);
                tax += taxInBracket;
                if (inBracket > 0) {
                    details.push({ ...bracket, amount: inBracket, tax: taxInBracket });
                }
            }
            
            return { gross: tax, details };
        }

        function calculateBituachLeumi(selfEmployedIncome) {
            const yd = getYearData();
            
            // Ensure blBrackets exists (migration support)
            if (!yd.settings.blBrackets) {
                yd.settings.blBrackets = createEmptyYearData().settings.blBrackets;
            }
            
            const brackets = yd.settings.blBrackets;
            let total = 0;
            let details = [];
            
            for (const bracket of brackets) {
                if (selfEmployedIncome <= bracket.min) break;
                const incomeInBracket = Math.min(selfEmployedIncome, bracket.max) - bracket.min;
                const amountInBracket = incomeInBracket * (bracket.totalRate / 100);
                total += amountInBracket;
                if (incomeInBracket > 0) {
                    details.push({
                        ...bracket,
                        income: incomeInBracket,
                        amount: amountInBracket
                    });
                }
            }
            
            return { total, details };
        }

        // ========== RENDERING ==========
        function renderAll() {
            const yd = getYearData();
            const totals = calculateTotals();
            const credits = calculateCredits();
            const creditValue = credits * yd.settings.creditValue * 12;
            const { gross: grossTax, details: taxDetails } = calculateIncomeTax(totals.taxableIncome);
            const netTax = Math.max(0, grossTax - creditValue);
            
            // Calculate BL on self-employed income only (for display)
            const blSelfEmployed = calculateBituachLeumi(totals.selfEmployedNet);
            
            // For total BL due - we use the total already paid since BL on salary/unemployment
            // is already deducted correctly by employer/BTL. We only need to calculate what's
            // due on self-employed income.
            const bl = blSelfEmployed;
            
            // Dashboard
            document.getElementById('dashSalary').textContent = formatCurrency(totals.salary);
            document.getElementById('dashUnemployment').textContent = formatCurrency(totals.unemployment);
            document.getElementById('dashMiluim').textContent = formatCurrency(totals.miluim);
            document.getElementById('dashSelfEmployed').textContent = formatCurrency(totals.selfEmployed);
            document.getElementById('dashTotalIncome').textContent = formatCurrency(totals.taxableIncome);
            document.getElementById('dashCredits').textContent = credits.toFixed(2);
            document.getElementById('dashTaxDue').textContent = formatCurrency(netTax);
            document.getElementById('dashTaxPaid').textContent = formatCurrency(totals.totalTaxPaid);
            document.getElementById('dashBLDue').textContent = formatCurrency(bl.total);
            document.getElementById('dashBLPaid').textContent = formatCurrency(totals.totalBLPaid);
            
            document.getElementById('dashTaxFromSalary').textContent = formatCurrency(totals.taxFromSalary);
            document.getElementById('dashTaxFromUnemployment').textContent = formatCurrency(totals.taxFromUnemployment);
            document.getElementById('dashTaxFromMiluim').textContent = formatCurrency(totals.taxFromMiluim);
            document.getElementById('dashTaxFromSelf').textContent = formatCurrency(totals.taxFromSelf);
            document.getElementById('dashTotalTaxPaid').textContent = formatCurrency(totals.totalTaxPaid);
            document.getElementById('dashTotalBLPaid').textContent = formatCurrency(totals.totalBLPaid);
            
            // Result boxes - Tax and BL separately
            const taxDiff = totals.totalTaxPaid - netTax;
            // BL diff: what was paid as advances for self-employed vs what's due on self-employed
            const blDiff = totals.blFromSelf - bl.total;
            
            // Tax result box
            const taxResultBox = document.getElementById('taxResultBox');
            const taxResultAmount = document.getElementById('taxResultAmount');
            const taxResultText = document.getElementById('taxResultText');
            
            if (taxDiff > 0) {
                taxResultBox.className = 'result-box refund';
                taxResultAmount.textContent = formatCurrency(taxDiff);
                taxResultText.textContent = 'ğŸ‰ ××’×™×¢ ×œ×š ×”×—×–×¨!';
            } else if (taxDiff < 0) {
                taxResultBox.className = 'result-box owe';
                taxResultAmount.textContent = formatCurrency(Math.abs(taxDiff));
                taxResultText.textContent = 'ğŸ’³ ×™×ª×¨×” ×œ×ª×©×œ×•×';
            } else {
                taxResultBox.className = 'result-box';
                taxResultBox.style.borderColor = 'var(--primary)';
                taxResultAmount.textContent = 'â‚ª0';
                taxResultAmount.style.color = 'var(--primary)';
                taxResultText.textContent = 'âœ“ ×××•×–×Ÿ';
            }
            
            // BL result box
            const blResultBox = document.getElementById('blResultBox');
            const blResultAmount = document.getElementById('blResultAmount');
            const blResultText = document.getElementById('blResultText');
            
            if (bl.total === 0 && totals.blFromSelf === 0) {
                blResultBox.className = 'result-box';
                blResultBox.style.borderColor = 'var(--border)';
                blResultAmount.textContent = 'â‚ª0';
                blResultAmount.style.color = 'var(--text-muted)';
                blResultText.textContent = '××™×Ÿ ×”×›× ×¡×” ×›×¢×¦×××™';
            } else if (blDiff > 0) {
                blResultBox.className = 'result-box refund';
                blResultAmount.textContent = formatCurrency(blDiff);
                blResultText.textContent = 'ğŸ‰ ×©×™×œ××ª ×™×•×ª×¨ ××“×™!';
            } else if (blDiff < 0) {
                blResultBox.className = 'result-box owe';
                blResultAmount.textContent = formatCurrency(Math.abs(blDiff));
                blResultText.textContent = 'ğŸ’³ ×™×ª×¨×” ×œ×ª×©×œ×•×';
            } else {
                blResultBox.className = 'result-box';
                blResultBox.style.borderColor = 'var(--warning)';
                blResultAmount.textContent = 'â‚ª0';
                blResultAmount.style.color = 'var(--warning)';
                blResultText.textContent = 'âœ“ ×××•×–×Ÿ';
            }
            
            // Tables
            renderSalaryTable();
            renderUnemploymentTable();
            renderMiluimTable(totals.miluimDays);
            renderSelfEmployedTable();
            renderExpenseTable(totals.expenses);
            renderTaxAdvanceTable();
            renderBLAdvanceTable();
            renderVatTable();
            
            // Credits
            document.getElementById('totalCredits').textContent = credits.toFixed(2);
            document.getElementById('creditValue').textContent = formatCurrency(creditValue);
            
            // Calculation page
            document.getElementById('calcSalary').textContent = formatCurrency(totals.salary);
            document.getElementById('calcUnemployment').textContent = formatCurrency(totals.unemployment);
            document.getElementById('calcSelfEmployed').textContent = formatCurrency(totals.selfEmployed);
            document.getElementById('calcExpenses').textContent = '-' + formatCurrency(totals.expenses);
            document.getElementById('calcMiluim').textContent = formatCurrency(totals.miluim);
            document.getElementById('calcTaxableIncome').textContent = formatCurrency(totals.taxableIncome);
            
            // Tax brackets breakdown
            let bracketsHTML = '';
            taxDetails.forEach(d => {
                bracketsHTML += `<div class="breakdown-item">
                    <span>${formatCurrency(d.min)} - ${formatCurrency(d.max)}</span>
                    <span class="rate">${d.rate}%</span>
                    <span>${formatCurrency(d.tax)}</span>
                </div>`;
            });
            document.getElementById('taxBracketsBreakdown').innerHTML = bracketsHTML || '<div class="empty-state">××™×Ÿ ×”×›× ×¡×” ×—×™×™×‘×ª</div>';
            
            document.getElementById('calcGrossTax').textContent = formatCurrency(grossTax);
            document.getElementById('calcCreditPoints').textContent = credits.toFixed(2);
            document.getElementById('calcCreditValue').textContent = '-' + formatCurrency(Math.min(creditValue, grossTax));
            document.getElementById('calcNetTax').textContent = formatCurrency(netTax);
            
            document.getElementById('calcBLIncome').textContent = formatCurrency(totals.selfEmployedNet);
            document.getElementById('calcBLReduced').textContent = formatCurrency(bl.reduced);
            document.getElementById('calcBLFull').textContent = formatCurrency(bl.full);
            document.getElementById('calcTotalBL').textContent = formatCurrency(bl.total);
            document.getElementById('calcBLPaid').textContent = formatCurrency(totals.totalBLPaid);
            
            // BL difference display (using blDiff from above)
            const blDiffEl = document.getElementById('blDiff');
            const blDiffLabelEl = document.getElementById('blDiffLabel');
            const blDiffRowEl = document.getElementById('blDiffRow');
            if (blDiff > 0) {
                blDiffLabelEl.textContent = 'ğŸ‰ ×©×™×œ××ª ×™×•×ª×¨ ××“×™';
                blDiffEl.textContent = formatCurrency(blDiff);
                blDiffEl.style.color = 'var(--success)';
            } else if (blDiff < 0) {
                blDiffLabelEl.textContent = 'ğŸ’³ × ×•×ª×¨ ×œ×©×œ×';
                blDiffEl.textContent = formatCurrency(Math.abs(blDiff));
                blDiffEl.style.color = 'var(--danger)';
            } else {
                blDiffLabelEl.textContent = '×”×¤×¨×©';
                blDiffEl.textContent = 'â‚ª0';
                blDiffEl.style.color = 'var(--text)';
            }
            
            document.getElementById('calcPaidSalary').textContent = formatCurrency(totals.taxFromSalary);
            document.getElementById('calcPaidUnemployment').textContent = formatCurrency(totals.taxFromUnemployment);
            document.getElementById('calcPaidMiluim').textContent = formatCurrency(totals.taxFromMiluim);
            document.getElementById('calcPaidSelf').textContent = formatCurrency(totals.taxFromSelf);
            document.getElementById('calcTotalPaid').textContent = formatCurrency(totals.totalTaxPaid);
            
            // Summary boxes for calculation page
            document.getElementById('calcSummaryTaxDue').textContent = formatCurrency(netTax);
            document.getElementById('calcSummaryTaxPaid').textContent = formatCurrency(totals.totalTaxPaid);
            document.getElementById('calcSummaryBLDue').textContent = formatCurrency(bl.total);
            document.getElementById('calcSummaryBLPaid').textContent = formatCurrency(totals.totalBLPaid);
            
            // Tax result
            const calcTaxResultRow = document.getElementById('calcTaxResultRow');
            const calcTaxResultLabel = document.getElementById('calcTaxResultLabel');
            const calcTaxResult = document.getElementById('calcTaxResult');
            if (taxDiff > 0) {
                calcTaxResultRow.style.background = 'rgba(16,185,129,0.1)';
                calcTaxResultLabel.textContent = 'ğŸ‰ ××’×™×¢ ×”×—×–×¨';
                calcTaxResult.textContent = formatCurrency(taxDiff);
                calcTaxResult.style.color = 'var(--success)';
            } else if (taxDiff < 0) {
                calcTaxResultRow.style.background = 'rgba(239,68,68,0.1)';
                calcTaxResultLabel.textContent = 'ğŸ’³ ×œ×ª×©×œ×•×';
                calcTaxResult.textContent = formatCurrency(Math.abs(taxDiff));
                calcTaxResult.style.color = 'var(--danger)';
            } else {
                calcTaxResultRow.style.background = '';
                calcTaxResultLabel.textContent = 'âœ“ ×××•×–×Ÿ';
                calcTaxResult.textContent = 'â‚ª0';
                calcTaxResult.style.color = 'var(--primary)';
            }
            
            // BL result
            const calcBLResultRow = document.getElementById('calcBLResultRow');
            const calcBLResultLabel = document.getElementById('calcBLResultLabel');
            const calcBLResult = document.getElementById('calcBLResult');
            if (blDiff > 0) {
                calcBLResultRow.style.background = 'rgba(16,185,129,0.1)';
                calcBLResultLabel.textContent = 'ğŸ‰ ×©×™×œ××ª ×™×•×ª×¨';
                calcBLResult.textContent = formatCurrency(blDiff);
                calcBLResult.style.color = 'var(--success)';
            } else if (blDiff < 0) {
                calcBLResultRow.style.background = 'rgba(239,68,68,0.1)';
                calcBLResultLabel.textContent = 'ğŸ’³ ×œ×ª×©×œ×•×';
                calcBLResult.textContent = formatCurrency(Math.abs(blDiff));
                calcBLResult.style.color = 'var(--danger)';
            } else {
                calcBLResultRow.style.background = '';
                calcBLResultLabel.textContent = 'âœ“ ×××•×–×Ÿ';
                calcBLResult.textContent = 'â‚ª0';
                calcBLResult.style.color = 'var(--warning)';
            }
            
            // Settings
            renderSettings();
            
            // Apply dashboard settings
            applyDashboardSettings();
        }

        function renderSalaryTable() {
            const yd = getYearData();
            const tbody = document.getElementById('salaryTable');
            if (yd.salary.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="icon">ğŸ’¼</div><p>×œ×—×¥ + ×œ×”×•×¡×™×£</p></td></tr>';
                return;
            }
            tbody.innerHTML = yd.salary.map(s => `<tr>
                <td>${s.employer || '-'} ${s.notes ? '<span title="'+s.notes+'" style="cursor:help;">ğŸ“</span>' : ''}</td>
                <td>${MONTHS[s.fromMonth]} - ${MONTHS[s.toMonth]}</td>
                <td>${formatCurrency(s.gross)}</td>
                <td>${formatCurrency(s.taxDeducted)}</td>
                <td>${formatCurrency(s.blDeducted)}</td>
                <td>
                    ${s.driveLink ? `<button class="btn btn-icon btn-sm" onclick="window.open('${s.driveLink}','_blank')" title="×¦×¤×” ×‘×§×•×‘×¥">ğŸ‘ï¸</button>` : ''}
                    <button class="btn btn-icon btn-sm" onclick="editSalary(${s.id})" title="×¢×¨×™×›×”">âœï¸</button>
                    <button class="btn btn-icon btn-sm" onclick="deleteItem('salary',${s.id})" title="××—×™×§×”">ğŸ—‘ï¸</button>
                </td>
            </tr>`).join('');
        }

        function renderUnemploymentTable() {
            const yd = getYearData();
            const tbody = document.getElementById('unemploymentTable');
            if (yd.unemployment.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="icon">ğŸ“‹</div><p>×œ×—×¥ + ×œ×”×•×¡×™×£</p></td></tr>';
                return;
            }
            tbody.innerHTML = yd.unemployment.map(u => `<tr>
                <td>${MONTHS[u.fromMonth]} - ${MONTHS[u.toMonth]} ${u.notes ? '<span title="'+u.notes+'" style="cursor:help;">ğŸ“</span>' : ''}</td>
                <td>${formatCurrency(u.gross)}</td>
                <td>${formatCurrency(u.taxDeducted)}</td>
                <td>${formatCurrency(u.blDeducted || 0)}</td>
                <td>
                    ${u.driveLink ? `<button class="btn btn-icon btn-sm" onclick="window.open('${u.driveLink}','_blank')" title="×¦×¤×” ×‘×§×•×‘×¥">ğŸ‘ï¸</button>` : ''}
                    <button class="btn btn-icon btn-sm" onclick="editUnemployment(${u.id})" title="×¢×¨×™×›×”">âœï¸</button>
                    <button class="btn btn-icon btn-sm" onclick="deleteItem('unemployment',${u.id})" title="××—×™×§×”">ğŸ—‘ï¸</button>
                </td>
            </tr>`).join('');
        }

        function renderMiluimTable(totalDays) {
            const yd = getYearData();
            const tbody = document.getElementById('miluimTable');
            const totalAmount = yd.miluim.reduce((s,m) => s+m.amount, 0);
            const totalTax = yd.miluim.reduce((s,m) => s+(m.taxDeducted || 0), 0);
            const totalBL = yd.miluim.reduce((s,m) => s+(m.blDeducted || 0), 0);
            
            document.getElementById('totalMiluimDays').textContent = totalDays;
            document.getElementById('totalMiluimAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('totalMiluimTax').textContent = formatCurrency(totalTax);
            document.getElementById('totalMiluimBL').textContent = formatCurrency(totalBL);
            
            if (yd.miluim.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="icon">ğŸ–ï¸</div><p>×œ×—×¥ + ×œ×”×•×¡×™×£</p></td></tr>';
                return;
            }
            tbody.innerHTML = yd.miluim.map(m => `<tr>
                <td>${m.from} - ${m.to} ${m.notes ? '<span title="'+m.notes+'" style="cursor:help;">ğŸ“</span>' : ''}</td>
                <td>${m.days}</td>
                <td>${formatCurrency(m.amount)}</td>
                <td style="color:var(--danger)">${formatCurrency(m.taxDeducted || 0)}</td>
                <td style="color:var(--warning)">${formatCurrency(m.blDeducted || 0)}</td>
                <td>
                    ${m.driveLink ? `<button class="btn btn-icon btn-sm" onclick="window.open('${m.driveLink}','_blank')" title="×¦×¤×” ×‘×§×•×‘×¥">ğŸ‘ï¸</button>` : ''}
                    <button class="btn btn-icon btn-sm" onclick="editMiluim(${m.id})" title="×¢×¨×™×›×”">âœï¸</button>
                    <button class="btn btn-icon btn-sm" onclick="deleteItem('miluim',${m.id})" title="××—×™×§×”">ğŸ—‘ï¸</button>
                </td>
            </tr>`).join('');
        }

        function renderSelfEmployedTable() {
            const yd = getYearData();
            const tbody = document.getElementById('selfEmployedTable');
            document.getElementById('selfEmployedWarning').style.display = yd.selfEmployed.length > 0 ? 'block' : 'none';
            
            if (yd.selfEmployed.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state"><div class="icon">ğŸ’°</div><p>×œ×—×¥ + ×œ×”×•×¡×™×£</p></td></tr>';
                return;
            }
            tbody.innerHTML = yd.selfEmployed.map(s => `<tr>
                <td>${MONTHS[s.month]}</td>
                <td>${s.description || '-'} ${s.notes ? '<span title="'+s.notes+'" style="cursor:help;">ğŸ“</span>' : ''}</td>
                <td>${formatCurrency(s.amount)}</td>
                <td>
                    ${s.driveLink ? `<button class="btn btn-icon btn-sm" onclick="window.open('${s.driveLink}','_blank')" title="×¦×¤×” ×‘×§×•×‘×¥">ğŸ‘ï¸</button>` : ''}
                    <button class="btn btn-icon btn-sm" onclick="editSelfEmployed(${s.id})" title="×¢×¨×™×›×”">âœï¸</button>
                    <button class="btn btn-icon btn-sm" onclick="deleteItem('selfEmployed',${s.id})" title="××—×™×§×”">ğŸ—‘ï¸</button>
                </td>
            </tr>`).join('');
        }

        function renderExpenseTable(total) {
            const yd = getYearData();
            const tbody = document.getElementById('expenseTable');
            document.getElementById('totalExpenses').textContent = formatCurrency(total);
            
            if (yd.expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="icon">ğŸ§¾</div><p>×œ×—×¥ + ×œ×”×•×¡×™×£</p></td></tr>';
                return;
            }
            tbody.innerHTML = yd.expenses.map(e => `<tr>
                <td>${e.date}</td>
                <td>${e.description || '-'} ${e.notes ? '<span title="'+e.notes+'" style="cursor:help;">ğŸ“</span>' : ''}</td>
                <td>${e.category}</td>
                <td style="color:var(--danger)">${formatCurrency(e.amount)}</td>
                <td>
                    ${e.driveLink ? `<button class="btn btn-icon btn-sm" onclick="window.open('${e.driveLink}','_blank')" title="×¦×¤×” ×‘×§×•×‘×¥">ğŸ‘ï¸</button>` : ''}
                    <button class="btn btn-icon btn-sm" onclick="editExpense(${e.id})" title="×¢×¨×™×›×”">âœï¸</button>
                    <button class="btn btn-icon btn-sm" onclick="deleteItem('expenses',${e.id})" title="××—×™×§×”">ğŸ—‘ï¸</button>
                </td>
            </tr>`).join('');
        }

        function renderTaxAdvanceTable() {
            const yd = getYearData();
            const tbody = document.getElementById('taxAdvanceTable');
            const tfoot = document.getElementById('taxAdvanceTotals');
            
            if (!yd.taxAdvances || yd.taxAdvances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="icon">ğŸ›ï¸</div><p>×œ×—×¥ + ×œ×”×•×¡×™×£ ××§×“××ª ××¡</p></td></tr>';
                tfoot.innerHTML = '';
                return;
            }
            
            let cumulative = 0;
            let total = 0;
            
            tbody.innerHTML = yd.taxAdvances.map(p => {
                cumulative += p.amount;
                total += p.amount;
                
                return `<tr>
                    <td>${MONTHS[p.month]}</td>
                    <td>${formatCurrency(p.amount)}</td>
                    <td style="color:var(--primary)">${formatCurrency(cumulative)}</td>
                    <td>${p.notes ? '<span title="'+p.notes+'" style="cursor:help;">ğŸ“</span>' : '-'}</td>
                    <td>
                        ${p.driveLink ? `<button class="btn btn-icon btn-sm" onclick="window.open('${p.driveLink}','_blank')" title="×¦×¤×” ×‘×§×•×‘×¥">ğŸ‘ï¸</button>` : ''}
                        <button class="btn btn-icon btn-sm" onclick="editTaxAdvance(${p.id})" title="×¢×¨×™×›×”">âœï¸</button>
                        <button class="btn btn-icon btn-sm" onclick="deleteTaxAdvance(${p.id})" title="××—×™×§×”">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
            }).join('');
            
            tfoot.innerHTML = `<tr style="background:rgba(239,68,68,0.1);font-weight:bold;">
                <td>×¡×”"×›</td>
                <td style="color:var(--danger)">${formatCurrency(total)}</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>`;
        }

        function renderBLAdvanceTable() {
            const yd = getYearData();
            const tbody = document.getElementById('blAdvanceTable');
            const tfoot = document.getElementById('blAdvanceTotals');
            
            if (!yd.blAdvances || yd.blAdvances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="icon">ğŸ¥</div><p>×œ×—×¥ + ×œ×”×•×¡×™×£ ×ª×©×œ×•× ×‘×™×˜"×œ</p></td></tr>';
                tfoot.innerHTML = '';
                return;
            }
            
            let cumulative = 0;
            let total = 0;
            
            tbody.innerHTML = yd.blAdvances.map(p => {
                cumulative += p.amount;
                total += p.amount;
                
                return `<tr>
                    <td>${MONTHS[p.month]}</td>
                    <td>${formatCurrency(p.amount)}</td>
                    <td style="color:var(--primary)">${formatCurrency(cumulative)}</td>
                    <td>${p.notes ? '<span title="'+p.notes+'" style="cursor:help;">ğŸ“</span>' : '-'}</td>
                    <td>
                        ${p.driveLink ? `<button class="btn btn-icon btn-sm" onclick="window.open('${p.driveLink}','_blank')" title="×¦×¤×” ×‘×§×•×‘×¥">ğŸ‘ï¸</button>` : ''}
                        <button class="btn btn-icon btn-sm" onclick="editBLAdvance(${p.id})" title="×¢×¨×™×›×”">âœï¸</button>
                        <button class="btn btn-icon btn-sm" onclick="deleteBLAdvance(${p.id})" title="××—×™×§×”">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
            }).join('');
            
            tfoot.innerHTML = `<tr style="background:rgba(245,158,11,0.1);font-weight:bold;">
                <td>×¡×”"×›</td>
                <td style="color:var(--warning)">${formatCurrency(total)}</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>`;
        }

        function renderSettings() {
            const yd = getYearData();
            
            // Ensure blBrackets exists (migration support)
            if (!yd.settings.blBrackets) {
                yd.settings.blBrackets = createEmptyYearData().settings.blBrackets;
            }
            
            // Update year displays
            const yearDisplayEls = [
                document.getElementById('settingsYearDisplay'),
                document.getElementById('taxBracketsYear'),
                document.getElementById('blBracketsYear')
            ];
            yearDisplayEls.forEach(el => { if (el) el.textContent = currentYear; });
            
            // Tax brackets
            let html = '<div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:10px;">×-×¡×›×•× | ×¢×“-×¡×›×•× | ××—×•×–</div>';
            yd.settings.taxBrackets.forEach((b, idx) => {
                const isLast = idx === yd.settings.taxBrackets.length - 1;
                html += `<div class="breakdown-item" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <input type="number" value="${b.min}" style="width:80px;padding:5px;border-radius:4px;border:1px solid var(--border);background:var(--bg-input);color:var(--text);text-align:right;" onchange="updateTaxBracket(${idx}, 'min', this.value)">
                    <span>-</span>
                    <input type="number" value="${isLast ? '' : b.max}" placeholder="${isLast ? 'âˆ' : ''}" ${isLast ? 'disabled' : ''} style="width:80px;padding:5px;border-radius:4px;border:1px solid var(--border);background:var(--bg-input);color:var(--text);text-align:right;${isLast ? 'opacity:0.5;' : ''}" onchange="updateTaxBracket(${idx}, 'max', this.value)">
                    <input type="number" value="${b.rate}" style="width:50px;padding:5px;border-radius:4px;border:1px solid var(--border);background:var(--bg-input);color:var(--text);text-align:center;" onchange="updateTaxBracket(${idx}, 'rate', this.value)">
                    <span>%</span>
                </div>`;
            });
            document.getElementById('settingsBrackets').innerHTML = html;
            
            // BL brackets table
            let blHtml = `
                <table style="width:100%;font-size:0.85rem;border-collapse:collapse;">
                    <thead>
                        <tr style="background:var(--bg-card);text-align:right;">
                            <th style="padding:8px;border-bottom:1px solid var(--border);">××“×¨×’×”</th>
                            <th style="padding:8px;border-bottom:1px solid var(--border);">×-×¡×›×•×</th>
                            <th style="padding:8px;border-bottom:1px solid var(--border);">×¢×“-×¡×›×•×</th>
                            <th style="padding:8px;border-bottom:1px solid var(--border);">×‘×™×˜"×œ %</th>
                            <th style="padding:8px;border-bottom:1px solid var(--border);">×‘×¨×™××•×ª %</th>
                            <th style="padding:8px;border-bottom:1px solid var(--border);">×¡×”"×› %</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            yd.settings.blBrackets.forEach((b, idx) => {
                blHtml += `
                    <tr>
                        <td style="padding:8px;border-bottom:1px solid var(--border);font-size:0.8rem;">${b.label || (idx === 0 ? '××•×¤×—×ª' : '××œ×')}</td>
                        <td style="padding:4px;border-bottom:1px solid var(--border);">
                            <input type="number" value="${b.min}" style="width:70px;padding:4px;border-radius:4px;border:1px solid var(--border);background:var(--bg-input);color:var(--text);text-align:right;" onchange="updateBLBracket(${idx}, 'min', this.value)">
                        </td>
                        <td style="padding:4px;border-bottom:1px solid var(--border);">
                            <input type="number" value="${b.max}" style="width:70px;padding:4px;border-radius:4px;border:1px solid var(--border);background:var(--bg-input);color:var(--text);text-align:right;" onchange="updateBLBracket(${idx}, 'max', this.value)">
                        </td>
                        <td style="padding:4px;border-bottom:1px solid var(--border);">
                            <input type="number" value="${b.blRate}" step="0.01" style="width:55px;padding:4px;border-radius:4px;border:1px solid var(--border);background:var(--bg-input);color:var(--text);text-align:center;" onchange="updateBLBracket(${idx}, 'blRate', this.value)">
                        </td>
                        <td style="padding:4px;border-bottom:1px solid var(--border);">
                            <input type="number" value="${b.healthRate}" step="0.01" style="width:55px;padding:4px;border-radius:4px;border:1px solid var(--border);background:var(--bg-input);color:var(--text);text-align:center;" onchange="updateBLBracket(${idx}, 'healthRate', this.value)">
                        </td>
                        <td style="padding:8px;border-bottom:1px solid var(--border);font-weight:bold;color:var(--primary);" id="blTotal${idx}">${b.totalRate.toFixed(2)}%</td>
                    </tr>
                `;
            });
            
            blHtml += '</tbody></table>';
            document.getElementById('settingsBLBrackets').innerHTML = blHtml;
            
            // Credit value
            document.getElementById('setCreditValue').value = yd.settings.creditValue;
        }

        function updateTaxBracket(idx, field, value) {
            const yd = getYearData();
            const numValue = parseFloat(value) || 0;
            
            if (field === 'min') {
                yd.settings.taxBrackets[idx].min = numValue;
                // Update previous bracket's max to match
                if (idx > 0) {
                    yd.settings.taxBrackets[idx - 1].max = numValue;
                }
            } else if (field === 'max') {
                yd.settings.taxBrackets[idx].max = numValue;
                // Update next bracket's min to match
                if (idx < yd.settings.taxBrackets.length - 1) {
                    yd.settings.taxBrackets[idx + 1].min = numValue;
                }
            } else if (field === 'rate') {
                yd.settings.taxBrackets[idx].rate = numValue;
            }
            
            saveData();
            renderAll();
        }

        function updateTaxBracketRate(idx, value) {
            updateTaxBracket(idx, 'rate', value);
        }

        function updateBLBracket(idx, field, value) {
            const yd = getYearData();
            const numValue = parseFloat(value) || 0;
            
            if (field === 'min') {
                yd.settings.blBrackets[idx].min = numValue;
                if (idx > 0) {
                    yd.settings.blBrackets[idx - 1].max = numValue;
                }
            } else if (field === 'max') {
                yd.settings.blBrackets[idx].max = numValue;
                if (idx < yd.settings.blBrackets.length - 1) {
                    yd.settings.blBrackets[idx + 1].min = numValue;
                }
            } else if (field === 'blRate' || field === 'healthRate') {
                yd.settings.blBrackets[idx][field] = numValue;
                // Update total
                yd.settings.blBrackets[idx].totalRate = 
                    (yd.settings.blBrackets[idx].blRate || 0) + 
                    (yd.settings.blBrackets[idx].healthRate || 0);
                // Update display
                const totalEl = document.getElementById('blTotal' + idx);
                if (totalEl) totalEl.textContent = yd.settings.blBrackets[idx].totalRate.toFixed(2) + '%';
            }
            
            saveData();
            renderAll();
        }

        function updateCreditValue() {
            const yd = getYearData();
            yd.settings.creditValue = parseFloat(document.getElementById('setCreditValue').value) || 242;
            saveData();
            renderAll();
        }

        // ========== UTILITIES ==========
        function formatCurrency(n) {
            return 'â‚ª' + Math.round(n).toLocaleString('he-IL');
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tax-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    if (confirm('×œ×™×™×‘×? ×™×—×œ×™×£ ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™×')) {
                        data = JSON.parse(ev.target.result);
                        saveData();
                        location.reload();
                    }
                } catch(err) { alert('×©×’×™××”'); }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('×œ××—×•×§ ×”×›×œ?') && confirm('×‘×˜×•×—?')) {
                localStorage.removeItem('taxCalculatorV2');
                location.reload();
            }
        }

        init();
    </script>
</body>
</html>
